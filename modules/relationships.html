<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Relacje - Simplify CRM</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- FONTS & STYLES -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700&family=Bebas+Neue&family=Outfit:wght@400;500;600;700&display=swap');

        :root {
            --bg-primary: #f5f1ed;
            --surface: #ffffff;
            --surface-soft: rgba(255, 255, 255, 0.88);
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-subtle: rgba(17, 24, 39, 0.12);
            --border-strong: rgba(17, 24, 39, 0.24);
            --shadow-soft: 0 18px 55px rgba(15, 23, 42, 0.18);
            --shadow-card: 0 10px 30px rgba(15, 23, 42, 0.16);
            --radius-card: 18px;
            --radius-chip: 999px;

            --accent: #2563eb;
            --success: #16a34a;
            --error: #dc2626;
        }

        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Manrope', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
        }

        button {
            font-family: inherit;
        }

        /* HEADER */
        .app-header {
            background: var(--surface);
            border-bottom: 1px solid var(--border-subtle);
            padding: 1.4rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .app-header-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .app-header-left {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .app-logo {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.9rem;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            cursor: pointer;
            transition: opacity 0.2s ease;
        }

        .app-logo:hover {
            opacity: 0.7;
        }

        .app-logo-subtitle {
            font-family: 'Outfit', sans-serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.14em;
            color: var(--text-secondary);
        }

        .app-header-right {
            display: flex;
            align-items: center;
            gap: 0.8rem;
        }

        .user-email {
            font-family: 'Outfit', sans-serif;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-secondary);
            max-width: 220px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .logout-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius-chip);
            border: 1px solid var(--border-strong);
            background: transparent;
            padding: 0.55rem 0.95rem;
            font-family: 'Outfit', sans-serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.18s ease, box-shadow 0.18s ease, transform 0.18s ease, border-color 0.18s ease;
        }

        .logout-btn:hover {
            background: rgba(15,23,42,0.03);
            border-color: var(--text-primary);
            box-shadow: 0 8px 20px rgba(15,23,42,0.16);
            transform: translateY(-1px);
        }

        /* BREADCRUMB */
        .breadcrumb {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1.5rem 2rem 0;
        }

        .back-to-dashboard {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            border-radius: var(--radius-chip);
            border: 1px solid var(--border-subtle);
            background: transparent;
            font-family: 'Outfit', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            cursor: pointer;
            transition: all 0.18s ease;
            text-decoration: none;
            color: var(--text-primary);
        }

        .back-to-dashboard:hover {
            background: rgba(15,23,42,0.03);
            border-color: var(--border-strong);
        }

        /* APP WRAPPER */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem 2rem 3.2rem;
        }

        /* GLOBAL SEARCH */

        .global-search {
            margin-bottom: 1.8rem;
        }

        .search-input-container {
            display: flex;
            align-items: center;
            gap: 0.4rem;
            background: var(--surface);
            border-radius: 999px;
            border: 1px solid var(--border-subtle);
            padding: 0.35rem 0.85rem;
            box-shadow: 0 8px 20px rgba(15,23,42,0.06);
        }

        .search-icon {
            font-size: 1rem;
            opacity: 0.7;
        }

        .search-input-container input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 0.55rem 0.5rem;
            font-size: 0.85rem;
            color: var(--text-primary);
        }

        .search-input-container input:focus {
            outline: none;
        }

        .clear-search-btn {
            border: none;
            background: transparent;
            font-family: 'Outfit', sans-serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            padding: 0.35rem 0.8rem;
            border-radius: 999px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: background 0.18s ease, color 0.18s ease;
        }

        .clear-search-btn:hover {
            background: rgba(15,23,42,0.05);
            color: var(--text-primary);
        }

        .search-hint {
            margin-top: 0.4rem;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* TABS */

        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .tab-btn {
            position: relative;
            padding: 0.85rem 1.4rem;
            font-family: 'Outfit', sans-serif;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .tab-btn::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--text-primary);
            transform: scaleX(0);
            transition: transform 0.2s ease;
        }

        .tab-btn.active {
            color: var(--text-primary);
        }

        .tab-btn.active::after {
            transform: scaleX(1);
        }

        .tab-btn:hover:not(.active) {
            color: var(--text-primary);
            opacity: 0.7;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* SECTION HEADER */

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2.2rem;
            gap: 1.5rem;
        }

        .section-header.small {
            margin-bottom: 1.4rem;
        }

        .section-title-block {
            flex: 1;
        }

        .section-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2.1rem;
            letter-spacing: 0.14em;
            text-transform: uppercase;
            margin-bottom: 0.35rem;
        }

        .section-header.small .section-title {
            font-size: 1.6rem;
        }

        .section-underline {
            width: 72px;
            height: 3px;
            background: linear-gradient(90deg, var(--text-primary), transparent);
            margin-bottom: 0.8rem;
        }

        .section-subtitle {
            font-size: 0.82rem;
            line-height: 1.6;
            color: var(--text-secondary);
            max-width: 44rem;
        }

        .toolbar {
            display: flex;
            align-items: center;
            gap: 0.7rem;
        }

        .add-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.72rem 1.25rem;
            border-radius: var(--radius-chip);
            border: 1px solid var(--text-primary);
            background: var(--text-primary);
            color: #f5f1ed;
            font-family: 'Outfit', sans-serif;
            font-size: 0.72rem;
            font-weight: 600;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            cursor: pointer;
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }

        .add-btn .plus {
            font-size: 1.2rem;
            font-weight: 400;
        }

        .add-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(15,23,42,0.24);
        }

        /* CARDS */

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.3rem;
        }

        .card {
            position: relative;
            background: var(--surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-card);
            padding: 1.6rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
        }

        .card.clickable {
            cursor: pointer;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-card);
            border-color: var(--border-strong);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 1rem;
        }

        .card-title {
            font-family: 'Outfit', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            color: var(--text-primary);
            margin-bottom: 0.3rem;
        }

        .card-meta {
            font-family: 'Outfit', sans-serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-secondary);
        }

        .card-actions {
            display: flex;
            gap: 0.4rem;
        }

        .icon-btn {
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: transparent;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.18s ease;
        }

        .icon-btn:hover {
            background: rgba(15,23,42,0.04);
            border-color: var(--border-strong);
        }

        .icon-btn.delete:hover {
            background: rgba(220,38,38,0.08);
            border-color: var(--error);
            color: var(--error);
        }

        .card-body {
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
        }

        .card-info-row {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .card-info-row .emoji {
            font-size: 1rem;
        }

        .card-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.8rem;
            border-radius: var(--radius-chip);
            background: rgba(15,23,42,0.06);
            font-family: 'Outfit', sans-serif;
            font-size: 0.68rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-primary);
            margin-top: 0.5rem;
        }

        .card-badge.no-company {
            background: rgba(220, 38, 38, 0.08);
            color: var(--error);
        }

        /* DETAIL VIEW + LAYOUT */

        .detail-view {
            display: none;
        }

        .detail-view.active {
            display: block;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.6rem 1rem;
            margin-bottom: 1.5rem;
            border-radius: var(--radius-chip);
            border: 1px solid var(--border-subtle);
            background: transparent;
            font-family: 'Outfit', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            cursor: pointer;
            transition: all 0.18s ease;
        }

        .back-btn:hover {
            background: rgba(15,23,42,0.03);
            border-color: var(--border-strong);
        }

        .detail-card {
            background: var(--surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-card);
            padding: 2rem;
            margin-bottom: 1.5rem;
        }

        .detail-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 2rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
            margin-bottom: 0.5rem;
        }

        .detail-meta {
            font-family: 'Outfit', sans-serif;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .detail-info {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .detail-info-row {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .detail-info-label {
            font-family: 'Outfit', sans-serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-weight: 600;
            color: var(--text-secondary);
            min-width: 120px;
        }

        .detail-info-value {
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .detail-info-value a {
            color: var(--accent);
            text-decoration: none;
        }

        .detail-info-value a:hover {
            text-decoration: underline;
        }

        .detail-layout {
            display: flex;
            align-items: flex-start;
            gap: 1.5rem;
        }

        .detail-column-left {
            flex: 0 0 40%;
            min-width: 0;
        }

        .detail-column-right {
            flex: 1;
            min-width: 0;
        }

        .detail-list {
            display: flex;
            flex-direction: column;
            gap: 0.9rem;
            max-height: 420px;
            overflow-y: auto;
            padding-right: 0.3rem;
        }

        .detail-list .card {
            padding: 1.1rem 1.3rem;
        }

        .detail-list .card-title {
            font-size: 1rem;
        }

        /* HISTORY */

        .history-header {
            margin-bottom: 1rem;
        }

        .history-header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            gap: 1rem;
        }

        .history-title {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.7rem;
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }

        .history-action-buttons {
            display: flex;
            align-items: center;
            gap: 0.7rem;
        }

        .history-controls {
            display: flex;
            align-items: center;
            gap: 0.7rem;
        }

        .history-tabs {
            display: inline-flex;
            border-radius: 999px;
            background: rgba(15,23,42,0.04);
            padding: 0.2rem;
        }

        .history-tab-btn {
            border: none;
            background: transparent;
            border-radius: 999px;
            padding: 0.35rem 0.9rem;
            font-family: 'Outfit', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            cursor: pointer;
            color: var(--text-secondary);
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .history-tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .history-tab-btn.active {
            background: #ffffff;
            color: var(--text-primary);
            box-shadow: 0 4px 10px rgba(15,23,42,0.12);
            transform: scale(1.05);
        }

        /* Smooth transition for tab content */
        .history-list {
            animation: fadeInUp 0.3s ease-out;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(8px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .history-tab-btn.active {
            background: #ffffff;
            color: var(--text-primary);
            box-shadow: 0 4px 10px rgba(15,23,42,0.12);
        }

        .history-add-btn {
            padding-inline: 1rem;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            max-height: 460px;
            overflow-y: auto;
        }

        .history-item {
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            padding: 0.8rem 1rem;
        }

        .history-item.note {
            border-left: 3px solid var(--accent);
        }

        .history-item.event {
            border-left: 3px solid var(--text-secondary);
        }

        .history-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.35rem;
        }

        .history-item-type {
            font-family: 'Outfit', sans-serif;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: var(--text-secondary);
        }

        .history-item-meta {
            font-size: 0.72rem;
            color: var(--text-secondary);
        }

        .history-item-body {
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .empty-state {
            text-align: center;
            padding: 5rem 2rem;
            color: var(--text-secondary);
        }

        .empty-state.small {
            padding: 2.2rem 1.4rem;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 1.5rem;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.1rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            margin-bottom: 0.6rem;
        }

        .empty-state p {
            font-size: 0.85rem;
            line-height: 1.6;
        }

        /* MODAL */

        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(15,23,42,0.55);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            position: relative;
            width: 100%;
            max-width: 520px;
            background: var(--surface);
            border-radius: var(--radius-card);
            border: 1px solid var(--border-subtle);
            padding: 2rem;
            box-shadow: var(--shadow-soft);
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.8rem;
        }

        .modal-header h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 1.8rem;
            letter-spacing: 0.14em;
            text-transform: uppercase;
        }

        .close-btn {
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: transparent;
            cursor: pointer;
            font-size: 1.3rem;
            line-height: 1;
            transition: all 0.18s ease;
        }

        .close-btn:hover {
            background: rgba(15,23,42,0.04);
            border-color: var(--border-strong);
        }

        .form-group {
            margin-bottom: 1.4rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-family: 'Outfit', sans-serif;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .form-group label .optional {
            font-weight: 400;
            opacity: 0.6;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 0.85rem 1.1rem;
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            background: var(--surface);
            font-family: 'Manrope', sans-serif;
            font-size: 0.9rem;
            color: var(--text-primary);
            transition: border-color 0.18s ease, box-shadow 0.18s ease;
        }

        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--text-primary);
            box-shadow: 0 0 0 3px rgba(15,23,42,0.08);
        }

        .modal-actions {
            display: flex;
            gap: 0.8rem;
            margin-top: 2rem;
        }

        .btn {
            flex: 1;
            padding: 0.85rem 1.4rem;
            border-radius: var(--radius-chip);
            font-family: 'Outfit', sans-serif;
            font-size: 0.72rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            cursor: pointer;
            transition: all 0.18s ease;
        }

        .btn-primary {
            border: 1px solid var(--text-primary);
            background: var(--text-primary);
            color: #f5f1ed;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 10px 24px rgba(15,23,42,0.24);
        }

        .btn-secondary {
            border: 1px solid var(--border-strong);
            background: transparent;
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: rgba(15,23,42,0.03);
            border-color: var(--text-primary);
        }

        /* COMPANY PICKER */

        .company-picker {
            position: relative;
        }

        .company-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 0.25rem;
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            box-shadow: 0 18px 40px rgba(15,23,42,0.22);
            max-height: 220px;
            overflow-y: auto;
            z-index: 1500;
            display: none;
        }

        .company-suggestions.visible {
            display: block;
        }

        .company-suggestion-item {
            padding: 0.55rem 0.9rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .company-suggestion-item:hover {
            background: rgba(15,23,42,0.04);
        }

        .company-suggestion-item .suggestion-meta {
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-left: 0.75rem;
        }

        .company-suggestion-new {
            font-weight: 600;
        }

        /* LOADING */

        .loading {
            text-align: center;
            padding: 4rem 2rem;
        }

        .spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--text-primary);
            border-radius: 50%;
            animation: spin 0.9s linear infinite;
            margin: 0 auto 1.2rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading p {
            font-family: 'Outfit', sans-serif;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-secondary);
        }

        /* STATUS MESSAGE */

        .status-message {
            position: fixed;
            top: 1.4rem;
            right: 1.4rem;
            padding: 0.85rem 1.1rem;
            border-radius: 12px;
            background: #ffffff;
            border: 1px solid rgba(15,23,42,0.16);
            box-shadow: 0 18px 40px rgba(15,23,42,0.22);
            font-family: 'Outfit', sans-serif;
            font-size: 0.72rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-primary);
            display: inline-flex;
            align-items: center;
            gap: 0.55rem;
            z-index: 2000;
            animation: slideInRight 0.3s ease-out;
        }

        .status-message::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 999px;
            background: var(--text-primary);
        }

        .status-message.success::before {
            background: var(--success);
        }

        .status-message.error::before {
            background: var(--error);
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(16px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        /* VIEW SWITCHER */
        .view-switcher {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            padding: 0.3rem;
            background: rgba(17, 24, 39, 0.06);
            border-radius: var(--radius-chip);
        }

        .view-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .view-btn:hover {
            background: rgba(17, 24, 39, 0.08);
            color: var(--text-primary);
        }

        .view-btn.active {
            background: var(--surface);
            color: var(--text-primary);
            box-shadow: 0 2px 8px rgba(15, 23, 42, 0.12);
        }

        .view-btn svg {
            width: 18px;
            height: 18px;
        }

        /* LIST VIEW */
        .list-view {
            background: var(--surface);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-card);
            overflow: hidden;
        }

        .list-view-table {
            width: 100%;
            border-collapse: collapse;
        }

        .list-view-table thead {
            background: rgba(17, 24, 39, 0.04);
        }

        .list-view-table th {
            padding: 1rem 1.2rem;
            text-align: left;
            font-family: 'Outfit', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border-subtle);
        }

        .list-view-table td {
            padding: 1rem 1.2rem;
            font-size: 0.85rem;
            border-bottom: 1px solid var(--border-subtle);
            color: var(--text-primary);
        }

        .list-view-table tbody tr {
            transition: background 0.15s ease;
        }

        .list-view-table tbody tr:hover {
            background: rgba(17, 24, 39, 0.02);
            cursor: pointer;
        }

        .list-view-table tbody tr:last-child td {
            border-bottom: none;
        }

        .list-view-table .actions-cell {
            display: flex;
            gap: 0.4rem;
            align-items: center;
        }

        .list-view-table .actions-cell button {
            padding: 0.4rem 0.6rem;
            font-size: 0.8rem;
        }

        /* RESPONSIVE */

        @media (max-width: 900px) {
            .detail-layout {
                flex-direction: column;
            }

            .detail-column-left,
            .detail-column-right {
                flex: 1 1 auto;
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 2.2rem 1.4rem 2.6rem;
            }

            .app-header-inner {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.9rem;
            }

            .app-header-right {
                width: 100%;
                justify-content: space-between;
            }

            .section-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .toolbar {
                width: 100%;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: 1.7rem 1.4rem 1.5rem;
                border-radius: 18px;
            }

            .tab-btn {
                padding: 0.7rem 1rem;
                font-size: 0.7rem;
            }

            .history-header-top {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.8rem;
            }

            .history-action-buttons {
                width: 100%;
                flex-direction: column;
            }

            .history-action-buttons .add-btn {
                width: 100%;
            }
        }

        @media (max-width: 480px) {
            .app-container {
                padding: 2rem 1.1rem 2.4rem;
            }

            .history-controls {
                flex-direction: column-reverse;
                align-items: flex-start;
                width: 100%;
            }
        }
    
        /* ============= TAGS SYSTEM ============= */
        
        /* Tag Manager Icon */
        .tags-manager-icon {
            width: 32px;
            height: 32px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            background: var(--surface);
            border: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: all 0.18s ease;
            margin-right: 0.8rem;
        }

        .tags-manager-icon:hover {
            background: rgba(15,23,42,0.04);
            border-color: var(--border-strong);
            box-shadow: 0 4px 10px rgba(15,23,42,0.16);
            transform: translateY(-1px);
        }

        .tags-manager-icon svg {
            width: 16px;
            height: 16px;
            opacity: 0.7;
        }

        /* Tags Modal */
        .tags-modal .modal-content {
            max-width: 680px;
        }

        .tags-modal-tabs {
            display: inline-flex;
            border-radius: 999px;
            background: rgba(15,23,42,0.04);
            padding: 0.25rem;
            margin-bottom: 1.8rem;
        }

        .tags-modal-tab {
            border: none;
            background: transparent;
            border-radius: 999px;
            padding: 0.45rem 1.2rem;
            font-family: 'Outfit', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.18s ease;
        }

        .tags-modal-tab.active {
            background: #ffffff;
            color: var(--text-primary);
            box-shadow: 0 4px 10px rgba(15,23,42,0.12);
        }

        /* Tag Form */
        .tag-form-section {
            background: var(--surface-soft);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .color-picker-grid {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .color-option {
            width: 100%;
            aspect-ratio: 1;
            border: 2px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.18s ease;
            position: relative;
        }

        .color-option:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .color-option.selected {
            border-color: var(--text-primary);
            transform: scale(1.15);
        }

        .color-option.selected::after {
            content: 'âœ“';
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }

        /* Tags List */
        .tags-list-section {
            margin-top: 1.5rem;
        }

        .tags-list-section h3 {
            font-family: 'Outfit', sans-serif;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        .tags-list {
            display: flex;
            flex-direction: column;
            gap: 0.6rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .tag-list-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--surface);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 0.8rem 1rem;
            transition: all 0.18s ease;
        }

        .tag-list-item:hover {
            border-color: var(--border-strong);
            box-shadow: 0 2px 8px rgba(15,23,42,0.08);
        }

        .tag-list-item-left {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            flex: 1;
            min-width: 0;
        }

        .tag-list-item-color {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            flex-shrink: 0;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .tag-list-item-info {
            flex: 1;
            min-width: 0;
        }

        .tag-list-item-name {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0.15rem;
        }

        .tag-list-item-desc {
            font-size: 0.75rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .tag-list-item-actions {
            display: flex;
            gap: 0.4rem;
            flex-shrink: 0;
        }

        .tag-action-btn {
            width: 28px;
            height: 28px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--border-subtle);
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.18s ease;
        }

        .tag-action-btn:hover {
            background: rgba(15,23,42,0.04);
            border-color: var(--border-strong);
        }

        .tag-action-btn svg {
            width: 14px;
            height: 14px;
        }

        /* Tag Badge - Minimal horizontal bars for cards */
        .tag-badge {
            position: relative;
            width: 24px;
            height: 4px;
            border-radius: 2px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .tag-badge:hover {
            height: 5px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
            transform: translateY(-1px);
        }

        /* Tooltip for tag name on hover */
        .tag-badge::before {
            content: attr(data-tag-name);
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%) scale(0.95);
            background: rgba(17, 24, 39, 0.97);
            color: white;
            padding: 0.45rem 0.75rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            letter-spacing: 0.02em;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .tag-badge:hover::before {
            opacity: 1;
            transform: translateX(-50%) scale(1);
        }

        /* Small arrow for tooltip */
        .tag-badge::after {
            content: '';
            position: absolute;
            bottom: calc(100% + 2px);
            left: 50%;
            transform: translateX(-50%);
            border: 6px solid transparent;
            border-top-color: rgba(17, 24, 39, 0.97);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tag-badge:hover::after {
            opacity: 1;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.4rem;
            align-items: center;
        }

        /* Tags bar in cards - horizontal layout */
        .card .tags-container {
            margin-top: 0.9rem;
            padding-top: 0.9rem;
            border-top: 1px solid var(--border-subtle);
        }

        /* Tags in detail view - inline with other info */
        .detail-tags-inline {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .detail-tag-item {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.3rem 0.65rem;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            letter-spacing: 0.01em;
            color: white;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 1px 3px rgba(0,0,0,0.12);
        }

        .detail-tag-item:hover {
            filter: brightness(1.08);
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }

        .detail-tag-item .remove-tag-btn {
            background: rgba(255, 255, 255, 0.25);
            border: none;
            color: white;
            cursor: pointer;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            line-height: 1;
            transition: all 0.15s ease;
            font-weight: 700;
            padding: 0;
        }

        .detail-tag-item .remove-tag-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(1.15);
        }

        /* Add tag button - small plus icon */
        .add-tag-btn {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: 1px solid var(--border-subtle);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .add-tag-btn:hover {
            background: rgba(17, 24, 39, 0.04);
            border-color: var(--text-primary);
            color: var(--text-primary);
            transform: scale(1.1);
        }

        /* Inline tag dropdown */
        .tag-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            background: var(--surface);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
            padding: 0.4rem;
            min-width: 180px;
            max-height: 240px;
            overflow-y: auto;
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transform: translateY(-8px);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .tag-dropdown.visible {
            opacity: 1;
            pointer-events: auto;
            transform: translateY(0);
        }

        .tag-dropdown-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.7rem;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.15s ease;
            font-size: 0.8rem;
        }

        .tag-dropdown-item:hover {
            background: rgba(17, 24, 39, 0.04);
        }

        .tag-dropdown-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .tag-dropdown-empty {
            padding: 1rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-style: italic;
        }

        /* Empty state for tags */
        .empty-state-small {
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-style: italic;
            padding: 0.5rem 0;
        }

        /* Tag assignment section */
        .tag-assignment {
            display: flex;
            gap: 0.5rem;
            align-items: stretch;
        }

        .tag-assignment select {
            flex: 1;
        }

        /* Detail section styles */
        .detail-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid var(--border-subtle);
        }

        .detail-section-header {
            margin-bottom: 1rem;
        }

        .detail-section-header h3 {
            font-family: 'Outfit', sans-serif;
            font-size: 0.9rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--text-secondary);
            margin: 0;
        }


        /* Tags in Card */
        .card .tags-container {
            margin-top: 0.8rem;
            padding-top: 0.8rem;
            border-top: 1px solid var(--border-subtle);
        }
/* ============= ACTIVITIES STYLES ============= */
        
        /* ACTIVITY TYPE SELECTOR */
        .activity-type-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.6rem;
            margin-top: 0.5rem;
        }

        .activity-type-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
            padding: 0.8rem;
            border: 2px solid var(--border-subtle);
            border-radius: 12px;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .activity-type-btn:hover {
            border-color: var(--border-strong);
            background: rgba(15,23,42,0.02);
        }

        .activity-type-btn.active {
            border-color: var(--text-primary);
            background: rgba(15,23,42,0.04);
        }

        .activity-type-btn .type-icon {
            font-size: 1.5rem;
        }

        .activity-type-btn .type-label {
            font-family: 'Outfit', sans-serif;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        /* ACTIVITY ITEM */
        .activity-item {
            background: var(--surface);
            border-radius: 12px;
            border: 1px solid var(--border-subtle);
            border-left-width: 3px;
            padding: 1rem;
            transition: all 0.2s ease;
        }

        .activity-item:hover {
            box-shadow: 0 4px 12px rgba(15,23,42,0.08);
            transform: translateY(-1px);
        }

        .activity-item-header {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            margin-bottom: 0.6rem;
        }

        .activity-item-icon {
            font-size: 1.2rem;
        }

        .activity-item-type {
            font-family: 'Outfit', sans-serif;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.16em;
            color: var(--text-secondary);
        }

        .activity-item-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 0.4rem;
        }

        .activity-item-date {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 0.4rem;
        }

        .activity-item-notes {
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--text-secondary);
            margin-bottom: 0.8rem;
        }

        .activity-item-actions {
            display: flex;
            gap: 0.4rem;
            margin-top: 0.8rem;
            padding-top: 0.8rem;
            border-top: 1px solid var(--border-subtle);
        }

        .activity-item-actions button {
            padding: 0.4rem 0.8rem;
            font-size: 0.75rem;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: transparent;
            cursor: pointer;
            transition: all 0.18s ease;
            font-family: 'Outfit', sans-serif;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
        }

        .activity-item-actions button:hover {
            background: rgba(15,23,42,0.04);
            border-color: var(--border-strong);
        }

        .activity-status {
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
            padding: 0.25rem 0.6rem;
            border-radius: 999px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            margin-left: auto;
        }

        .activity-status.planned {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }

        .activity-status.completed {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .activity-status.cancelled {
            background: rgba(107, 114, 128, 0.1);
            color: #6b7280;
        }
</style>
</head>
<body>
    <!-- HEADER -->
    <header class="app-header">
        <div class="app-header-inner">
            <div class="app-header-left">
                <div class="app-logo" onclick="window.location.href='../index.html'">Simplify CRM</div>
                <div class="app-logo-subtitle">ModuÅ‚: Relacje</div>
            </div>
            <div class="app-header-right">
                <span class="user-email" id="userEmail"></span>
                <button id="logoutBtn" class="logout-btn">Wyloguj</button>
            </div>
        </div>
    </header>

    <!-- BREADCRUMB -->
    <div class="breadcrumb">
        <a href="../index.html" class="back-to-dashboard">
            <span>â†</span>
            <span>PowrÃ³t do Dashboard</span>
        </a>
    </div>

    <!-- APP -->
    <div class="app-container">
        <!-- GLOBAL SEARCH -->
        <div class="global-search">
            <div class="search-input-container">
                <span class="search-icon">ðŸ”</span>
                <input id="globalSearchInput" type="text" placeholder="Szukaj w firmach i kontaktach..." autocomplete="off">
                <button id="clearSearchBtn" type="button" class="clear-search-btn">WyczyÅ›Ä‡</button>
            </div>
            <p class="search-hint">
                Szukaj po nazwie firmy, osobie, stanowisku, e-mailu, telefonie, branÅ¼y, mieÅ›cie itd.
            </p>
        </div>

        <!-- TABS -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="contacts">Kontakty</button>
            <button class="tab-btn" data-tab="companies">Firmy</button>
        </div>

        <!-- TAB: CONTACTS -->
        <div id="contactsTab" class="tab-content active">
            <!-- LIST VIEW -->
            <div id="contactsListView">
                <div class="section-header">
                    <div class="section-title-block">
                        <h1 class="section-title">Kontakty</h1>
                        <div class="section-underline"></div>
                        <p class="section-subtitle">
                            ZarzÄ…dzaj wszystkimi osobami kontaktowymi. Kontakty mogÄ… byÄ‡ przypisane do firm lub istnieÄ‡ niezaleÅ¼nie.
                        </p>
                    </div>
                    <div class="toolbar">
                                                <!-- Tags Manager Icon -->
                        <button class="tags-manager-icon" onclick="openTagsManager('contacts')" title="ZarzÄ…dzaj etykietami">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                                <line x1="7" y1="7" x2="7.01" y2="7"></line>
                            </svg>
                        </button>
<div class="view-switcher">
                            <button class="view-btn active" data-view="grid" title="Widok kafelkÃ³w" onclick="switchContactsView('grid')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7" stroke-linecap="round" stroke-linejoin="round"/>
                                    <rect x="14" y="3" width="7" height="7" stroke-linecap="round" stroke-linejoin="round"/>
                                    <rect x="14" y="14" width="7" height="7" stroke-linecap="round" stroke-linejoin="round"/>
                                    <rect x="3" y="14" width="7" height="7" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <button class="view-btn" data-view="list" title="Widok listy" onclick="switchContactsView('list')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="8" y1="6" x2="21" y2="6" stroke-linecap="round"/>
                                    <line x1="8" y1="12" x2="21" y2="12" stroke-linecap="round"/>
                                    <line x1="8" y1="18" x2="21" y2="18" stroke-linecap="round"/>
                                    <line x1="3" y1="6" x2="3.01" y2="6" stroke-linecap="round"/>
                                    <line x1="3" y1="12" x2="3.01" y2="12" stroke-linecap="round"/>
                                    <line x1="3" y1="18" x2="3.01" y2="18" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                        <button id="addContactBtn" class="add-btn">
                            <span class="plus">+</span>
                            <span>Dodaj kontakt</span>
                        </button>
                    </div>
                </div>

                <div id="contactsLoading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Åadowanie kontaktÃ³w...</p>
                </div>

                <div id="contactsEmpty" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                    </svg>
                    <h3>Brak kontaktÃ³w</h3>
                    <p>Dodaj pierwszy kontakt, aby rozpoczÄ…Ä‡ pracÄ™ w CRM.</p>
                </div>

                <div id="contactsGrid" class="cards-grid"></div>
                <div id="contactsList" class="list-view" style="display: none;"></div>
            </div>

            <!-- CONTACT DETAIL VIEW -->
            <div id="contactDetailView" class="detail-view">
                <button id="backToContactsBtn" class="back-btn">
                    <span>â†</span>
                    <span>PowrÃ³t do listy kontaktÃ³w</span>
                </button>

                <div class="detail-layout">
                    <!-- LEFT: INFO CARD + COMPANY OF CONTACT -->
                    <div class="detail-column-left">
                        <div class="detail-card">
                            <div id="contactDetailContent"></div>
                        </div>
                        <div class="section-header small">
                            <div class="section-title-block">
                                <h1 class="section-title">Firma kontaktu</h1>
                                <div class="section-underline"></div>
                            </div>
                        </div>

                        <div id="contactCompanyEmpty" class="empty-state small" style="display: none;">
                            <h3>Brak firmy</h3>
                            <p>Ten kontakt nie jest jeszcze przypisany do firmy.</p>
                        </div>

                        <div id="contactCompanyCardContainer" class="detail-list"></div>
                    </div>

                    <!-- RIGHT: CONTACT HISTORY -->
                    <div class="detail-column-right">
                        <div class="history-header">
                            <div class="history-header-top">
                                <h2 class="history-title">Historia klienta</h2>
                                <div class="history-action-buttons">
                                    <button id="addCompanyActivityBtn" class="add-btn history-add-btn">
                                        <span class="plus">+</span>
                                        <span>Dodaj aktywnoÅ›Ä‡</span>
                                    </button>
                                    <button id="addCompanyNoteBtn" class="add-btn history-add-btn">
                                        <span class="plus">+</span>
                                        <span>Dodaj notatkÄ™</span>
                                    </button>
                                </div>
                            </div>
                            <div class="history-controls">
                                <div class="history-tabs">
                                    <button class="history-tab-btn active" data-entity="company" data-scope="all">Wszystko</button>
                                    <button class="history-tab-btn" data-entity="company" data-scope="notes">Notatki</button>
                                    <button class="history-tab-btn" data-entity="company" data-scope="activities">AktywnoÅ›ci</button>
                                    <button class="history-tab-btn" data-entity="company" data-scope="full">Full stream</button>
                                </div>
                            </div>
                        </div>

                        <div id="contactHistoryEmpty" class="empty-state small" style="display:none;">
                            <h3>Brak historii</h3>
                            <p>Nie dodano jeszcze Å¼adnych notatek ani zdarzeÅ„ dla tego kontaktu.</p>
                        </div>
                        <div id="contactHistoryList" class="history-list"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- TAB: COMPANIES -->
        <div id="companiesTab" class="tab-content">
            <!-- COMPANY LIST VIEW -->
            <div id="companiesListView">
                <div class="section-header">
                    <div class="section-title-block">
                        <h1 class="section-title">Firmy</h1>
                        <div class="section-underline"></div>
                        <p class="section-subtitle">
                            ZarzÄ…dzaj listÄ… firm, z ktÃ³rymi wspÃ³Å‚pracujesz. KaÅ¼da firma moÅ¼e mieÄ‡ przypisanych wielu kontaktÃ³w oraz historiÄ™ wspÃ³Å‚pracy.
                        </p>
                    </div>
                    <div class="toolbar">
                                                <!-- Tags Manager Icon -->
                        <button class="tags-manager-icon" onclick="openTagsManager('companies')" title="ZarzÄ…dzaj etykietami">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path>
                                <line x1="7" y1="7" x2="7.01" y2="7"></line>
                            </svg>
                        </button>
<div class="view-switcher">
                            <button class="view-btn active" data-view="grid" title="Widok kafelkÃ³w" onclick="switchCompaniesView('grid')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7" stroke-linecap="round" stroke-linejoin="round"/>
                                    <rect x="14" y="3" width="7" height="7" stroke-linecap="round" stroke-linejoin="round"/>
                                    <rect x="14" y="14" width="7" height="7" stroke-linecap="round" stroke-linejoin="round"/>
                                    <rect x="3" y="14" width="7" height="7" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                            <button class="view-btn" data-view="list" title="Widok listy" onclick="switchCompaniesView('list')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="8" y1="6" x2="21" y2="6" stroke-linecap="round"/>
                                    <line x1="8" y1="12" x2="21" y2="12" stroke-linecap="round"/>
                                    <line x1="8" y1="18" x2="21" y2="18" stroke-linecap="round"/>
                                    <line x1="3" y1="6" x2="3.01" y2="6" stroke-linecap="round"/>
                                    <line x1="3" y1="12" x2="3.01" y2="12" stroke-linecap="round"/>
                                    <line x1="3" y1="18" x2="3.01" y2="18" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                        <button id="addCompanyBtn" class="add-btn">
                            <span class="plus">+</span>
                            <span>Dodaj firmÄ™</span>
                        </button>
                    </div>
                </div>

                <div id="companiesLoading" class="loading" style="display: none;">
                    <div class="spinner"></div>
                    <p>Åadowanie firm...</p>
                </div>

                <div id="companiesEmpty" class="empty-state" style="display: none;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                    <h3>Brak firm</h3>
                    <p>Dodaj pierwszÄ… firmÄ™, aby rozpoczÄ…Ä‡ pracÄ™ w CRM.</p>
                </div>

                <div id="companiesGrid" class="cards-grid"></div>
                <div id="companiesList" class="list-view" style="display: none;"></div>
            </div>

            <!-- COMPANY DETAIL VIEW -->
            <div id="companyDetailView" class="detail-view">
                <button id="backToCompaniesBtn" class="back-btn">
                    <span>â†</span>
                    <span>PowrÃ³t do listy firm</span>
                </button>

                <div class="detail-layout">
                    <!-- LEFT: INFO CARD + CONTACTS IN COMPANY -->
                    <div class="detail-column-left">
                        <div class="detail-card">
                            <div id="companyDetailContent"></div>
                        </div>
                        <div class="section-header small">
                            <div class="section-title-block">
                                <h1 class="section-title">Kontakty w firmie</h1>
                                <div class="section-underline"></div>
                            </div>
                            <div class="toolbar">
                                <button id="addCompanyContactBtn" class="add-btn">
                                    <span class="plus">+</span>
                                    <span>Dodaj kontakt</span>
                                </button>
                            </div>
                        </div>

                        <div id="companyContactsEmpty" class="empty-state small" style="display: none;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            <h3>Brak kontaktÃ³w</h3>
                            <p>Dodaj pierwszy kontakt dla tej firmy.</p>
                        </div>

                        <div id="companyContactsList" class="detail-list"></div>
                    </div>

                    <!-- RIGHT: COMPANY HISTORY -->
                    <div class="detail-column-right">
                        <div class="history-header">
                            <div class="history-header-top">
                                <h2 class="history-title">Historia kontaktu</h2>
                                <div class="history-action-buttons">
                                    <button id="addContactActivityBtn" class="add-btn history-add-btn">
                                        <span class="plus">+</span>
                                        <span>Dodaj aktywnoÅ›Ä‡</span>
                                    </button>
                                    <button id="addContactNoteBtn" class="add-btn history-add-btn">
                                        <span class="plus">+</span>
                                        <span>Dodaj notatkÄ™</span>
                                    </button>
                                </div>
                            </div>
                            <div class="history-controls">
                                <div class="history-tabs">
                                    <button class="history-tab-btn active" data-entity="contact" data-scope="all">Wszystko</button>
                                    <button class="history-tab-btn" data-entity="contact" data-scope="notes">Notatki</button>
                                    <button class="history-tab-btn" data-entity="contact" data-scope="activities">AktywnoÅ›ci</button>
                                    <button class="history-tab-btn" data-entity="contact" data-scope="full">Full stream</button>
                                </div>
                            </div>
                        </div>

                        <div id="companyHistoryEmpty" class="empty-state small" style="display:none;">
                            <h3>Brak historii</h3>
                            <p>Nie dodano jeszcze Å¼adnych notatek ani zdarzeÅ„ dla tej firmy.</p>
                        </div>
                        <div id="companyHistoryList" class="history-list"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: ADD/EDIT COMPANY -->
    <div id="companyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="companyModalTitle">Dodaj firmÄ™</h2>
                <button class="close-btn" id="closeCompanyModalBtn">&times;</button>
            </div>
<form id="companyForm">
                <div class="form-group">
                    <label for="companyName">Nazwa firmy *</label>
                    <input type="text" id="companyName" required>
                </div>
                <div class="form-group">
                    <label for="companyDomain">Domena <span class="optional">(opcjonalnie)</span></label>
                    <input type="text" id="companyDomain" placeholder="np. techcorp.pl">
                    <small style="display: block; margin-top: 0.4rem; font-size: 0.75rem; color: var(--text-secondary); line-height: 1.5;">
                        ðŸ’¡ Strona WWW zostanie utworzona automatycznie na podstawie domeny.
                    </small>
                </div>
                <div class="form-group">
                    <label for="companyIndustry">BranÅ¼a <span class="optional">(opcjonalnie)</span></label>
                    <input type="text" id="companyIndustry" placeholder="np. IT, Marketing, Finanse">
                </div>
                <div class="form-group">
                    <label for="companyPhone">Telefon firmowy <span class="optional">(opcjonalnie)</span></label>
                    <input type="tel" id="companyPhone" placeholder="np. +48 123 456 789">
                </div>
                <div class="form-group">
                    <label for="companyCity">Miasto <span class="optional">(opcjonalnie)</span></label>
                    <input type="text" id="companyCity" placeholder="np. Warszawa">
                </div>
                <div class="form-group">
                    <label for="companyCountry">Kraj <span class="optional">(opcjonalnie)</span></label>
                    <input type="text" id="companyCountry" placeholder="np. Polska">
                </div>
                <div class="form-group">
                    <label>Etykiety</label>
                    <div id="companyTagsSelector" class="tags-selector-container">
                        <span style="font-size:0.8rem; color:var(--text-secondary);">Najpierw utwÃ³rz etykiety w ustawieniach (ikona ðŸ·ï¸)</span>
                    </div>
                </div>
                <div class="form-group">
                    <label for="companyNotes">Notatki <span class="optional">(opcjonalnie)</span></label>
                    <textarea id="companyNotes" placeholder="Dodatkowe informacje o firmie"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelCompanyBtn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: ADD/EDIT CONTACT -->
    <div id="contactModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="contactModalTitle">Dodaj kontakt</h2>
                <button class="close-btn" id="closeContactModalBtn">&times;</button>
            </div>
            <form id="contactForm">
                <div class="form-group">
                    <label for="contactName">ImiÄ™ i nazwisko *</label>
                    <input type="text" id="contactName" required>
                </div>
                <div class="form-group">
                    <label for="contactEmail">Email <span class="optional">(opcjonalnie)</span></label>
                    <input type="email" id="contactEmail" placeholder="np. jan@techcorp.pl">
                </div>
                <div class="form-group">
                    <label for="contactCompanyInput">Firma <span class="optional">(opcjonalnie)</span></label>
                    <div class="company-picker">
                        <input type="text" id="contactCompanyInput" placeholder="Zacznij pisaÄ‡ nazwÄ™ firmy...">
                        <input type="hidden" id="contactCompanyId">
                        <div id="companySuggestions" class="company-suggestions"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="contactPosition">Stanowisko <span class="optional">(opcjonalnie)</span></label>
                    <input type="text" id="contactPosition" placeholder="np. CEO, Marketing Manager">
                </div>
                <div class="form-group">
                    <label for="contactPhone">Telefon <span class="optional">(opcjonalnie)</span></label>
                    <input type="tel" id="contactPhone">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelContactBtn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: ADD NOTE -->
    <div id="noteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="noteModalTitle">Dodaj notatkÄ™</h2>
                <button class="close-btn" id="closeNoteModalBtn">&times;</button>
            </div>
            <form id="noteForm">
                <input type="hidden" id="noteEntityType">
                <input type="hidden" id="noteEntityId">
                <div class="form-group">
                    <label for="noteContent">TreÅ›Ä‡ notatki *</label>
                    <textarea id="noteContent" required placeholder="Wpisz notatkÄ™ dotyczÄ…cÄ… tej firmy / kontaktu..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelNoteBtn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz notatkÄ™</button>
                </div>
            </form>
        </div>
    </div>

    <!-- MODAL: DUPLICATE WARNING -->
    <div id="duplicateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âš ï¸ MoÅ¼liwy duplikat</h2>
                <button class="close-btn" onclick="closeDuplicateModal()">&times;</button>
            </div>
            <div id="duplicateContent" style="margin: 1.5rem 0; line-height: 1.7;"></div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" id="backToEditBtn">WrÃ³Ä‡ do edycji</button>
                <button type="button" class="btn btn-primary" id="saveAnywayBtn">Zapisz mimo to</button>
            </div>
        </div>
    </div>

    <!-- Google APIs -->
    <script src="https://apis.google.com/js/api.js" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>

    <!-- CRM LOGIC -->
    <script type="module">
        import { CONFIG } from '../shared/config.js';
        import { AuthService } from '../shared/auth.js';
        import { DataService } from '../shared/data-service.js';
        import { ActivitiesService } from '../shared/activities-service.js';

        // ============= AUTH GUARD =============
        if (!AuthService.requireAuth()) {
            throw new Error('Unauthorized - redirecting to login');
        }

        // ============= VARIABLES =============
                // Tags variables
        let companyTags = [];
        let contactTags = [];
        let companyTagRelations = [];
        let contactTagRelations = [];
        let currentTagFilter = null;
        let currentTagType = 'companies';
        let companyActivities = [];
        let contactActivities = [];
        let currentActivityType = 'EMAIL';

        let companies = [];
        let contacts = [];
        let companyHistory = [];
        let contactHistory = [];

        let editingCompanyIndex = null;
        let editingContactIndex = null;
        let currentCompanyId = null;
        let currentContactId = null;
        let currentSearchTerm = '';

        let currentCompanyHistoryScope = 'all';
        let currentContactHistoryScope = 'all';

        let companyInputEl = null;
        let companyIdEl = null;
        let companySuggestionsEl = null;

        let noteEntityTypeEl = null;
        let noteEntityIdEl = null;
        let noteContentEl = null;

        let contactsViewMode = 'grid';
        let companiesViewMode = 'grid';

        // ============= INIT =============
        async function init() {
            try {
                // Set user email in header
                const email = AuthService.getUserEmail();
                if (email) {
                    // Load user preferences
                    await loadUserPreferences(email);
                    
                    // Display name or email
                    const displayText = AuthService.getUserDisplayText();
                    document.getElementById('userEmail').textContent = displayText;
                }

                // Initialize GAPI
                await initializeGAPI();

                // Set token
                AuthService.setGAPIToken();

                // Load data
                await loadData();

                console.log('âœ“ Relationships module initialized');

            } catch (error) {
                console.error('BÅ‚Ä…d inicjalizacji moduÅ‚u:', error);
                alert('WystÄ…piÅ‚ bÅ‚Ä…d podczas Å‚adowania danych. SprawdÅº konsolÄ™.');
            }
        }

        // ============= GAPI INIT =============
        async function initializeGAPI() {
            return new Promise((resolve, reject) => {
                if (typeof gapi === 'undefined') {
                    reject(new Error('GAPI nie jest zaÅ‚adowane'));
                    return;
                }

                gapi.load('client', async () => {
                    try {
                        await gapi.client.init({
                            apiKey: '',
                            discoveryDocs: CONFIG.API.DISCOVERY_DOCS,
                        });
                        console.log('âœ“ GAPI initialized');
                        resolve();
                    } catch (error) {
                        reject(error);
                    }
                });
            });
        }

        // ============= DATA LOADING =============
        async function loadData() {
            // Show loading indicators
            const companiesLoading = document.getElementById('companiesLoading');
            const contactsLoading = document.getElementById('contactsLoading');
            companiesLoading.style.display = 'block';
            contactsLoading.style.display = 'block';

            try {
                // STEP 1: Load all data FIRST (no rendering yet!)
                [companies, contacts] = await Promise.all([
                    DataService.loadCompanies(),
                    DataService.loadContacts()
                ]);

                // STEP 2: Load tags and history
                await loadTagsData();
                await Promise.all([
                    loadCompanyHistory(), 
                    loadContactHistory(),
                    loadActivitiesData()
                ]);

                // STEP 3: NOW render everything (all data is available)
                renderCompanies();
                renderAllContacts();

                console.log('âœ“ Wszystkie dane zaÅ‚adowane i wyÅ›wietlone');
            } catch (err) {
                console.error('BÅ‚Ä…d Å‚adowania danych:', err);
                showStatus('BÅ‚Ä…d Å‚adowania danych', 'error');
            } finally {
                // Hide loading indicators
                companiesLoading.style.display = 'none';
                contactsLoading.style.display = 'none';
            }
        }

        async function loadCompanies() {
            const loading = document.getElementById('companiesLoading');
            const grid = document.getElementById('companiesGrid');
            const empty = document.getElementById('companiesEmpty');

            loading.style.display = 'block';
            grid.innerHTML = '';
            empty.style.display = 'none';

            try {
                companies = await DataService.loadCompanies();
                renderCompanies();
            } catch (err) {
                console.error('BÅ‚Ä…d Å‚adowania firm:', err);
                showStatus('BÅ‚Ä…d Å‚adowania firm (sprawdÅº arkusz "Firmy")', 'error');
                empty.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        async function loadContacts() {
            const loading = document.getElementById('contactsLoading');
            const grid = document.getElementById('contactsGrid');
            const empty = document.getElementById('contactsEmpty');

            loading.style.display = 'block';
            grid.innerHTML = '';
            empty.style.display = 'none';

            try {
                contacts = await DataService.loadContacts();
                renderAllContacts();
            } catch (err) {
                console.error('BÅ‚Ä…d Å‚adowania kontaktÃ³w:', err);
                showStatus('BÅ‚Ä…d Å‚adowania kontaktÃ³w (sprawdÅº arkusz "Kontakty")', 'error');
                empty.style.display = 'block';
            } finally {
                loading.style.display = 'none';
            }
        }

        async function loadCompanyHistory() {
            companyHistory = [];
            try {
                companyHistory = await DataService.loadCompanyHistory();
            } catch (err) {
                console.warn('HistoriaFirm nie jest dostÄ™pna:', err);
            }
        }

        async function loadContactHistory() {
            contactHistory = [];
            try {
                contactHistory = await DataService.loadContactHistory();
            } catch (err) {
                console.warn('HistoriaKontaktow nie jest dostÄ™pna:', err);
            }
        }

        // ============= FILTER HELPERS =============
        function getFilteredCompanies() {
            let result = companies;
            
            // Search filter
            if (currentSearchTerm) {
                const q = currentSearchTerm.toLowerCase();
                result = result.filter(c => {
                    const combined = `${c.name} ${c.industry} ${c.notes} ${c.website} ${c.phone} ${c.city} ${c.country}`.toLowerCase();
                    return combined.includes(q);
                });
            }
            
            // Tag filter
            if (currentTagFilter && currentTagFilter.type === 'company') {
                result = DataService.getCompaniesByTag(
                    currentTagFilter.id,
                    result,
                    companyTagRelations
                );
            }
            
            return result;
        }

        function getFilteredContacts() {
            let result = contacts;
            
            // Search filter
            if (currentSearchTerm) {
                const q = currentSearchTerm.toLowerCase();
                result = result.filter(contact => {
                    const company = companies.find(c => c.id === contact.companyId);
                    const companyText = company
                        ? `${company.name} ${company.industry} ${company.city} ${company.country}`
                        : '';
                    const combined = `${contact.name} ${contact.position} ${contact.email} ${contact.phone} ${companyText}`.toLowerCase();
                    return combined.includes(q);
                });
            }
            
            // Tag filter
            if (currentTagFilter && currentTagFilter.type === 'contact') {
                result = DataService.getContactsByTag(
                    currentTagFilter.id,
                    result,
                    contactTagRelations
                );
            }
            
            return result;
        }

        // ============= RENDER COMPANIES =============
        function renderCompanies() {
            const grid = document.getElementById('companiesGrid');
            const listView = document.getElementById('companiesList');
            const empty = document.getElementById('companiesEmpty');
            const list = getFilteredCompanies();

            if (companies.length === 0) {
                grid.innerHTML = '';
                if (listView) listView.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            if (list.length === 0) {
                grid.innerHTML = '';
                if (listView) listView.innerHTML = '';
                empty.style.display = 'block';
                empty.querySelector('h3').textContent = 'Brak wynikÃ³w';
                empty.querySelector('p').textContent = 'Brak firm dla aktualnego wyszukiwania.';
                return;
            }

            empty.style.display = 'none';

            if (companiesViewMode === 'list' && listView) {
                listView.innerHTML = `
                    <table class="list-view-table">
                        <thead>
                            <tr>
                                <th>Nazwa firmy</th>
                                <th>BranÅ¼a</th>
                                <th>Miasto</th>
                                <th>Telefon</th>
                                <th>Kontakty</th>
                                <th style="width: 100px;">Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${list.map(company => {
                                const companyContacts = contacts.filter(c => c.companyId === company.id);
                                const idx = companies.indexOf(company);
                                return `
                                    <tr onclick="viewCompanyDetail('${company.id}')">
                                        <td><strong>${escapeHtml(company.name)}</strong></td>
                                        <td>${company.industry ? escapeHtml(company.industry) : '-'}</td>
                                        <td>${company.city ? escapeHtml(company.city) : '-'}</td>
                                        <td>${company.phone ? escapeHtml(company.phone) : '-'}</td>
                                        <td>ðŸ‘¥ ${companyContacts.length}</td>
                                        <td onclick="event.stopPropagation()">
                                            <div class="actions-cell">
                                                <button class="icon-btn" onclick="editCompany(${idx})" title="Edytuj">âœï¸</button>
                                                <button class="icon-btn delete" onclick="deleteCompany(${idx})" title="UsuÅ„">ðŸ—‘ï¸</button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                grid.innerHTML = list.map(company => {
                    const companyContacts = contacts.filter(c => c.companyId === company.id);
                    let infoRows = '';

                    if (company.website) {
                        infoRows += `<div class="card-info-row"><span class="emoji">ðŸŒ</span><span>${escapeHtml(company.website)}</span></div>`;
                    }
                    if (company.phone) {
                        infoRows += `<div class="card-info-row"><span class="emoji">ðŸ“ž</span><span>${escapeHtml(company.phone)}</span></div>`;
                    }
                    if (company.city || company.country) {
                        const loc = [company.city, company.country].filter(Boolean).join(', ');
                        infoRows += `<div class="card-info-row"><span class="emoji">ðŸ“</span><span>${escapeHtml(loc)}</span></div>`;
                    }

                    const idx = companies.indexOf(company);
                    return `
                        <div class="card clickable" onclick="viewCompanyDetail('${company.id}')">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">${escapeHtml(company.name)}</div>
                                    ${company.industry ? `<div class="card-meta">${escapeHtml(company.industry)}</div>` : ''}
                                </div>
                                <div class="card-actions" onclick="event.stopPropagation()">
                                    <button class="icon-btn" onclick="editCompany(${idx})" title="Edytuj">âœï¸</button>
                                    <button class="icon-btn delete" onclick="deleteCompany(${idx})" title="UsuÅ„">ðŸ—‘ï¸</button>
                                </div>
                            </div>
                            ${infoRows ? `<div class="card-body">${infoRows}</div>` : ''}
                            
                            ${renderEntityTags(company.id, 'company')}
                            <div class="card-badge"><span>ðŸ‘¥</span><span>${companyContacts.length} kontaktÃ³w</span></div>
                        </div>
                    `;
                }).join('');
            }
        }

        // ============= RENDER CONTACTS =============
        function renderAllContacts() {
            const grid = document.getElementById('contactsGrid');
            const listView = document.getElementById('contactsList');
            const empty = document.getElementById('contactsEmpty');
            const list = getFilteredContacts();

            if (contacts.length === 0) {
                grid.innerHTML = '';
                if (listView) listView.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            if (list.length === 0) {
                grid.innerHTML = '';
                if (listView) listView.innerHTML = '';
                empty.style.display = 'block';
                empty.querySelector('h3').textContent = 'Brak wynikÃ³w';
                empty.querySelector('p').textContent = 'Brak kontaktÃ³w dla aktualnego wyszukiwania.';
                return;
            }

            empty.style.display = 'none';

            if (contactsViewMode === 'list' && listView) {
                listView.innerHTML = `
                    <table class="list-view-table">
                        <thead>
                            <tr>
                                <th>ImiÄ™ i nazwisko</th>
                                <th>Firma</th>
                                <th>Stanowisko</th>
                                <th>Email</th>
                                <th>Telefon</th>
                                <th style="width: 100px;">Akcje</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${list.map(contact => {
                                const index = contacts.findIndex(c => c.id === contact.id);
                                const company = companies.find(c => c.id === contact.companyId);
                                return `
                                    <tr onclick="viewContactDetail('${contact.id}')">
                                        <td><strong>${escapeHtml(contact.name)}</strong></td>
                                        <td>${company ? escapeHtml(company.name) : '<span style="color: var(--text-secondary);">Brak</span>'}</td>
                                        <td>${contact.position ? escapeHtml(contact.position) : '-'}</td>
                                        <td>${contact.email ? escapeHtml(contact.email) : '-'}</td>
                                        <td>${contact.phone ? escapeHtml(contact.phone) : '-'}</td>
                                        <td onclick="event.stopPropagation()">
                                            <div class="actions-cell">
                                                <button class="icon-btn" onclick="editContact(${index})" title="Edytuj">âœï¸</button>
                                                <button class="icon-btn delete" onclick="deleteContact(${index})" title="UsuÅ„">ðŸ—‘ï¸</button>
                                            </div>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } else {
                grid.innerHTML = list.map(contact => {
                    const index = contacts.findIndex(c => c.id === contact.id);
                    const company = companies.find(c => c.id === contact.companyId);
                    return `
                        <div class="card clickable" onclick="viewContactDetail('${contact.id}')">
                            <div class="card-header">
                                <div>
                                    <div class="card-title">${escapeHtml(contact.name)}</div>
                                    ${contact.position ? `<div class="card-meta">${escapeHtml(contact.position)}</div>` : ''}
                                </div>
                                <div class="card-actions" onclick="event.stopPropagation()">
                                    <button class="icon-btn" onclick="editContact(${index})" title="Edytuj">âœï¸</button>
                                    <button class="icon-btn delete" onclick="deleteContact(${index})" title="UsuÅ„">ðŸ—‘ï¸</button>
                                </div>
                            </div>
                            <div class="card-body">
                                ${company ? `<div class="card-info-row"><span class="emoji">ðŸ¢</span><span>${escapeHtml(company.name)}</span></div>` : `<div class="card-badge no-company"><span>âš ï¸</span><span>Brak firmy</span></div>`}
                                ${contact.email ? `<div class="card-info-row"><span class="emoji">ðŸ“§</span><span>${escapeHtml(contact.email)}</span></div>` : ''}
                                ${contact.phone ? `<div class="card-info-row"><span class="emoji">ðŸ“±</span><span>${escapeHtml(contact.phone)}</span></div>` : ''}
                            
                            ${renderEntityTags(contact.id, 'contact')}
                        </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // ============= COMPANY DETAIL =============
        function viewCompanyDetail(companyId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-tab="companies"]').classList.add('active');
            document.getElementById('companiesTab').classList.add('active');

            currentCompanyId = companyId;
            const company = companies.find(c => c.id === companyId);
            if (!company) return;

            document.getElementById('companiesListView').style.display = 'none';
            document.getElementById('companyDetailView').classList.add('active');

            let infoHtml = '';
            if (company.website) {
                const url = company.website.startsWith('http') ? company.website : 'https://' + company.website;
                infoHtml += `<div class="detail-info-row"><div class="detail-info-label">Strona WWW</div><div class="detail-info-value"><a href="${escapeHtml(url)}" target="_blank">${escapeHtml(company.website)}</a></div></div>`;
            }
            if (company.phone) infoHtml += `<div class="detail-info-row"><div class="detail-info-label">Telefon</div><div class="detail-info-value">${escapeHtml(company.phone)}</div></div>`;
            if (company.city || company.country) {
                const loc = [company.city, company.country].filter(Boolean).join(', ');
                infoHtml += `<div class="detail-info-row"><div class="detail-info-label">Lokalizacja</div><div class="detail-info-value">${escapeHtml(loc)}</div></div>`;
            }
            if (company.notes) infoHtml += `<div class="detail-info-row"><div class="detail-info-label">Notatki</div><div class="detail-info-value">${escapeHtml(company.notes)}</div></div>`;

            document.getElementById('companyDetailContent').innerHTML = `
                <div style="position: relative;">
                    <button class="icon-btn" onclick="editCompanyFromDetail('${company.id}')" title="Edytuj firmÄ™" style="position: absolute; top: 0; right: 0;">âœï¸</button>
                    <div class="detail-title">${escapeHtml(company.name)}</div>
                </div>
                ${company.industry ? `<div class="detail-meta">${escapeHtml(company.industry)}</div>` : ''}
                
                <div class="detail-info">
                    ${infoHtml || '<div class="detail-info-row"><div class="detail-info-label">Informacje</div><div class="detail-info-value">Brak dodatkowych informacji.</div></div>'}
                    
                    ${renderDetailTags(company.id, 'company')}
                </div>
            `;
            
            // Setup tag dropdown toggle
            const addBtn = document.getElementById('addCompanyTagBtn');
            if (addBtn) {
                addBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleTagDropdown('companyTagDropdown', 'addCompanyTagBtn');
                });
            }

            renderCompanyContacts(companyId);
            renderCompanyHistory(companyId);
        }

        function backToCompaniesList() {
            document.getElementById('companyDetailView').classList.remove('active');
            document.getElementById('companiesListView').style.display = 'block';
            currentCompanyId = null;
        }

        function renderCompanyContacts(companyId) {
            const companyContacts = contacts.filter(c => c.companyId === companyId);
            const list = document.getElementById('companyContactsList');
            const empty = document.getElementById('companyContactsEmpty');

            if (companyContacts.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            list.innerHTML = companyContacts.map(contact => {
                const index = contacts.findIndex(c => c.id === contact.id);
                return `
                    <div class="card clickable" onclick="viewContactDetail('${contact.id}')">
                        <div class="card-header">
                            <div>
                                <div class="card-title">${escapeHtml(contact.name)}</div>
                                ${contact.position ? `<div class="card-meta">${escapeHtml(contact.position)}</div>` : ''}
                            </div>
                            <div class="card-actions" onclick="event.stopPropagation()">
                                <button class="icon-btn" onclick="editContact(${index})" title="Edytuj">âœï¸</button>
                                <button class="icon-btn delete" onclick="deleteContact(${index})" title="UsuÅ„">ðŸ—‘ï¸</button>
                            </div>
                        </div>
                        <div class="card-body">
                            ${contact.email ? `<div class="card-info-row"><span class="emoji">ðŸ“§</span><span>${escapeHtml(contact.email)}</span></div>` : ''}
                            ${contact.phone ? `<div class="card-info-row"><span class="emoji">ðŸ“±</span><span>${escapeHtml(contact.phone)}</span></div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ============= CONTACT DETAIL =============
        function viewContactDetail(contactId) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector('[data-tab="contacts"]').classList.add('active');
            document.getElementById('contactsTab').classList.add('active');

            currentContactId = contactId;
            const contact = contacts.find(c => c.id === contactId);
            if (!contact) return;

            document.getElementById('contactsListView').style.display = 'none';
            document.getElementById('contactDetailView').classList.add('active');

            const company = companies.find(c => c.id === contact.companyId);
            let infoHtml = '';
            if (contact.email) infoHtml += `<div class="detail-info-row"><div class="detail-info-label">Email</div><div class="detail-info-value">${escapeHtml(contact.email)}</div></div>`;
            if (contact.phone) infoHtml += `<div class="detail-info-row"><div class="detail-info-label">Telefon</div><div class="detail-info-value">${escapeHtml(contact.phone)}</div></div>`;
            if (company) infoHtml += `<div class="detail-info-row"><div class="detail-info-label">Firma</div><div class="detail-info-value"><span style="cursor:pointer;text-decoration:underline;" onclick="viewCompanyDetail('${company.id}')">${escapeHtml(company.name)}</span></div></div>`;

            document.getElementById('contactDetailContent').innerHTML = `
                <div style="position: relative;">
                    <button class="icon-btn" onclick="editContactFromDetail('${contact.id}')" title="Edytuj kontakt" style="position: absolute; top: 0; right: 0;">âœï¸</button>
                    <div class="detail-title">${escapeHtml(contact.name)}</div>
                </div>
                ${contact.position ? `<div class="detail-meta">${escapeHtml(contact.position)}</div>` : ''}
                
                <div class="detail-info">
                    ${infoHtml || '<div class="detail-info-row"><div class="detail-info-label">Informacje</div><div class="detail-info-value">Brak dodatkowych informacji.</div></div>'}
                    
                    ${renderDetailTags(contact.id, 'contact')}
                </div>
            `;
            
            // Setup tag dropdown toggle
            const addBtn = document.getElementById('addContactTagBtn');
            if (addBtn) {
                addBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleTagDropdown('contactTagDropdown', 'addContactTagBtn');
                });
            }

            const companyContainer = document.getElementById('contactCompanyCardContainer');
            const companyEmpty = document.getElementById('contactCompanyEmpty');
            if (company) {
                companyEmpty.style.display = 'none';
                companyContainer.innerHTML = `
                    <div class="card clickable" onclick="viewCompanyDetail('${company.id}')">
                        <div class="card-header">
                            <div>
                                <div class="card-title">${escapeHtml(company.name)}</div>
                                ${company.industry ? `<div class="card-meta">${escapeHtml(company.industry)}</div>` : ''}
                            </div>
                        </div>
                        <div class="card-body">
                            ${company.website ? `<div class="card-info-row"><span class="emoji">ðŸŒ</span><span>${escapeHtml(company.website)}</span></div>` : ''}
                            ${company.phone ? `<div class="card-info-row"><span class="emoji">ðŸ“ž</span><span>${escapeHtml(company.phone)}</span></div>` : ''}
                        </div>
                    </div>
                `;
            } else {
                companyContainer.innerHTML = '';
                companyEmpty.style.display = 'block';
            }

            renderContactHistory(contactId);
        }

        function backToContactsList() {
            document.getElementById('contactDetailView').classList.remove('active');
            document.getElementById('contactsListView').style.display = 'block';
            currentContactId = null;
        }

        // ============= COMPANY CRUD =============
        function openCompanyModal() {
            editingCompanyIndex = null;
            document.getElementById('companyModalTitle').textContent = 'Dodaj firmÄ™';
            document.getElementById('companyForm').reset();
            document.getElementById('companyModal').classList.add('active');
        }

function editCompany(index) {
            editingCompanyIndex = index;
            const company = companies[index];
            document.getElementById('companyModalTitle').textContent = 'Edytuj firmÄ™';
            document.getElementById('companyName').value = company.name;
            document.getElementById('companyIndustry').value = company.industry || '';
            
            // ObsÅ‚uga pola Website (jeÅ›li istnieje w HTML)
            if(document.getElementById('companyWebsite')) {
                document.getElementById('companyWebsite').value = company.website || '';
            }
            
            document.getElementById('companyPhone').value = company.phone || '';
            document.getElementById('companyCity').value = company.city || '';
            document.getElementById('companyCountry').value = company.country || '';
            document.getElementById('companyDomain').value = company.domain || '';
            document.getElementById('companyNotes').value = company.notes || '';
            
            // Tagi - waÅ¼ne dla zachowania danych
            if (typeof renderTagSelector === 'function') {
                renderTagSelector('companyTagsSelector', 'company', company.tags || '');
            }
            
            document.getElementById('companyModal').classList.add('active');
        }

        function editCompanyFromDetail(companyId) {
            const index = companies.findIndex(c => c.id === companyId);
            if (index !== -1) editCompany(index);
        }

async function saveCompany(e) {
            e.preventDefault();

            // 1. Pobierz wartoÅ›ci
            const name = document.getElementById('companyName').value.trim();
            const domain = document.getElementById('companyDomain').value.trim();
            const phone = document.getElementById('companyPhone').value.trim();
            const industry = document.getElementById('companyIndustry').value.trim();
            const city = document.getElementById('companyCity').value.trim();
            const country = document.getElementById('companyCountry').value.trim();
            const notes = document.getElementById('companyNotes').value.trim();
            
            // 2. ObsÅ‚uga WWW (Pobierz z inputa lub wygeneruj z domeny)
            let website = document.getElementById('companyWebsite') ? document.getElementById('companyWebsite').value.trim() : '';
            if (!website && domain) {
                website = domain.startsWith('http') ? domain : `https://${domain}`;
            }

            // === DEDUPLIKACJA START ===
            const cleanUrl = (url) => url ? url.toLowerCase().replace(/^(?:https?:\/\/)?(?:www\.)?/i, '').replace(/\/$/, '') : '';
            const cleanPhone = (ph) => ph ? ph.replace(/[\s-]/g, '') : '';
            const cleanName = (str) => str ? str.toLowerCase().replace(/\b(sp\.? ?z ?o\.?o\.?|s\.?a\.?|inc\.?|ltd\.?|gmbh)\b/g, '').replace(/[.,"\-]/g, '').replace(/\s+/g, ' ').trim() : '';

            if (!window.skipDuplicateCheck) {
                const currentId = editingCompanyIndex !== null ? companies[editingCompanyIndex].id : null;
                const inputCleanWeb = cleanUrl(website);
                const inputCleanDomain = cleanUrl(domain);
                const inputCleanPhone = cleanPhone(phone);
                const inputCleanName = cleanName(name);

                const duplicate = companies.find(c => {
                    if (c.id === currentId) return false;
                    
                    // A. Nazwa (inteligentne dopasowanie)
                    const storedCleanName = cleanName(c.name);
                    const matchName = inputCleanName && storedCleanName && inputCleanName === storedCleanName;

                    // B. WWW / Domena (krzyÅ¼owe sprawdzanie)
                    const storedWeb = cleanUrl(c.website);
                    const storedDomain = cleanUrl(c.domain);
                    const matchWeb = (inputCleanWeb && (inputCleanWeb === storedWeb || inputCleanWeb === storedDomain)) ||
                                     (inputCleanDomain && (inputCleanDomain === storedWeb || inputCleanDomain === storedDomain));

                    // C. Telefon
                    const matchPhone = inputCleanPhone && cleanPhone(c.phone) === inputCleanPhone;

                    return matchName || matchWeb || matchPhone;
                });

                if (duplicate) {
                    const modal = document.getElementById('duplicateModal');
                    const content = document.getElementById('duplicateContent');
                    const saveAnywayBtn = document.getElementById('saveAnywayBtn');
                    const backBtn = document.getElementById('backToEditBtn');

                    content.innerHTML = `
                        <div>Znaleziono firmÄ™ o podobnych danych:</div>
                        <div style="background:rgba(15,23,42,0.05); padding:12px; border-radius:8px; margin-top:10px; border:1px solid var(--border-subtle);">
                            <div style="font-size:1.1em; font-weight:600;">ðŸ¢ ${escapeHtml(duplicate.name)}</div>
                            ${duplicate.domain ? `<div>ðŸŒ ${escapeHtml(duplicate.domain)}</div>` : ''}
                            ${duplicate.phone ? `<div>ðŸ“ž ${escapeHtml(duplicate.phone)}</div>` : ''}
                        </div>
                        <div style="margin-top:15px; font-size:0.9rem;">Czy na pewno chcesz utworzyÄ‡ nowÄ…?</div>
                    `;
                    modal.classList.add('active');
                    
                    saveAnywayBtn.onclick = () => { 
                        window.skipDuplicateCheck = true; 
                        modal.classList.remove('active'); 
                        document.getElementById('companyForm').requestSubmit(); 
                    };
                    backBtn.onclick = () => { 
                        modal.classList.remove('active'); 
                        window.skipDuplicateCheck = false; 
                    };
                    return; // STOP
                }
            }
            window.skipDuplicateCheck = false;
            // === DEDUPLIKACJA KONIEC ===

            // Pobierz tagi (Logic from your latest file)
            let tagsIds = '';
            if (typeof getSelectedTagsFromSelector === 'function') {
                tagsIds = getSelectedTagsFromSelector('companyTagsSelector');
            } else if (editingCompanyIndex !== null) {
                tagsIds = companies[editingCompanyIndex].tags || '';
            }

            const company = {
                id: editingCompanyIndex !== null ? companies[editingCompanyIndex].id : DataService.generateId(),
                name, industry, website, phone, city, country, domain, notes,
                tags: tagsIds
            };

            try {
                await DataService.saveCompany(company, editingCompanyIndex);
                
                if (editingCompanyIndex !== null) {
                    companies[editingCompanyIndex] = company;
                    await DataService.logCompanyHistory(company.id, 'event', 'Firma zaktualizowana');
                    showStatus('Firma zaktualizowana', 'success');
                } else {
                    companies.push(company);
                    await DataService.logCompanyHistory(company.id, 'event', 'Firma utworzona');
                    showStatus('Firma dodana', 'success');
                }

                renderCompanies();
                if (currentCompanyId === company.id) viewCompanyDetail(company.id);
                closeCompanyModal();
                await loadCompanyHistory();
            } catch (err) {
                console.error('BÅ‚Ä…d zapisu firmy:', err);
                showStatus('BÅ‚Ä…d zapisu firmy', 'error');
            }
        }

        async function deleteCompany(index) {
            if (!confirm('Czy na pewno chcesz usunÄ…Ä‡ tÄ™ firmÄ™?')) return;
            try {
                const companyId = companies[index].id;
                await DataService.logCompanyHistory(companyId, 'event', 'Firma usuniÄ™ta');
                await DataService.deleteCompany(index);

                const detachPromises = [];
                contacts.forEach((contact, cIndex) => {
                    if (contact.companyId === companyId) {
                        contact.companyId = '';
                        detachPromises.push(DataService.saveContact(contact, cIndex));
                        DataService.logContactHistory(contact.id, 'event', `Kontakt odpiÄ™ty od usuniÄ™tej firmy`);
                    }
                });
                if (detachPromises.length) await Promise.all(detachPromises);

                companies.splice(index, 1);
                renderCompanies();
                renderAllContacts();
                if (currentCompanyId === companyId) backToCompaniesList();
                showStatus('Firma usuniÄ™ta', 'success');
                await loadCompanyHistory();
            } catch (err) {
                console.error('BÅ‚Ä…d usuwania firmy:', err);
                showStatus('BÅ‚Ä…d usuwania firmy', 'error');
            }
        }

        function closeCompanyModal() {
            document.getElementById('companyModal').classList.remove('active');
            document.getElementById('companyForm').reset();
            editingCompanyIndex = null;
        }

        // ============= CONTACT CRUD =============
        function openContactModal(preselectedCompanyId = null) {
            editingContactIndex = null;
            document.getElementById('contactModalTitle').textContent = 'Dodaj kontakt';
            document.getElementById('contactForm').reset();
            fillCompanyField(preselectedCompanyId);
            hideCompanySuggestions();
            document.getElementById('contactModal').classList.add('active');
        }

        function editContact(index) {
            editingContactIndex = index;
            const contact = contacts[index];
            document.getElementById('contactModalTitle').textContent = 'Edytuj kontakt';
            document.getElementById('contactName').value = contact.name;
            document.getElementById('contactPosition').value = contact.position;
            document.getElementById('contactEmail').value = contact.email;
            document.getElementById('contactPhone').value = contact.phone;
            fillCompanyField(contact.companyId || null);
            hideCompanySuggestions();
            document.getElementById('contactModal').classList.add('active');
        }

        function editContactFromDetail(contactId) {
            const index = contacts.findIndex(c => c.id === contactId);
            if (index !== -1) editContact(index);
        }

        function fillCompanyField(companyId) {
            if (!companyInputEl || !companyIdEl) return;
            if (!companyId) {
                companyInputEl.value = '';
                companyIdEl.value = '';
                return;
            }
            const company = companies.find(c => c.id === companyId);
            if (company) {
                companyInputEl.value = company.name;
                companyIdEl.value = company.id;
            }
        }

        async function saveContact(e) {
            e.preventDefault();
            const typedCompanyName = (companyInputEl?.value || '').trim();
            let selectedCompanyId = companyIdEl?.value || '';
            
            const name = document.getElementById('contactName').value.trim();
            const email = document.getElementById('contactEmail').value.trim();
            const phone = document.getElementById('contactPhone').value.trim();
            const position = document.getElementById('contactPosition').value.trim();

            // === DEDUPLIKACJA START ===
            if (!window.skipDuplicateCheck) {
                const currentId = editingContactIndex !== null ? contacts[editingContactIndex].id : null;
                const duplicate = contacts.find(c => {
                    if (c.id === currentId) return false;
                    
                    const matchName = name && c.name && c.name.toLowerCase() === name.toLowerCase();
                    const matchEmail = email && c.email && c.email.toLowerCase() === email.toLowerCase();
                    const clean = (p) => (p || '').replace(/[\s-]/g, '');
                    const matchPhone = phone && c.phone && clean(phone) === clean(c.phone);
                    
                    return matchName || matchEmail || matchPhone;
                });

                if (duplicate) {
                    const modal = document.getElementById('duplicateModal');
                    const content = document.getElementById('duplicateContent');
                    const saveAnywayBtn = document.getElementById('saveAnywayBtn');
                    const backBtn = document.getElementById('backToEditBtn');

                    content.innerHTML = `
                        <div>Znaleziono kontakt o podobnych danych:</div>
                        <div style="background:rgba(15,23,42,0.05); padding:12px; border-radius:8px; margin-top:10px; border:1px solid var(--border-subtle);">
                            <div style="font-size:1.1em; font-weight:600;">${escapeHtml(duplicate.name)}</div>
                            ${duplicate.email ? `<div>ðŸ“§ ${escapeHtml(duplicate.email)}</div>` : ''}
                            ${duplicate.phone ? `<div>ðŸ“± ${escapeHtml(duplicate.phone)}</div>` : ''}
                        </div>
                        <div style="margin-top:15px; font-size:0.9rem;">Czy na pewno chcesz utworzyÄ‡ ten kontakt?</div>
                    `;
                    modal.classList.add('active');
                    saveAnywayBtn.onclick = () => {
                        window.skipDuplicateCheck = true;
                        modal.classList.remove('active');
                        document.getElementById('contactForm').requestSubmit(); 
                    };
                    backBtn.onclick = () => {
                        modal.classList.remove('active');
                        window.skipDuplicateCheck = false;
                    };
                    return; // STOP
                }
            }
            window.skipDuplicateCheck = false;
            // === DEDUPLIKACJA KONIEC ===

            // Auto-match by domain
            if (!typedCompanyName && !selectedCompanyId && email) {
                const domain = DataService.extractDomain(email);
                const matchedCompany = DataService.findCompanyByDomain(companies, domain);
                if (matchedCompany) {
                    selectedCompanyId = matchedCompany.id;
                    companyInputEl.value = matchedCompany.name;
                    showStatus(`ðŸŽ¯ Auto-dopasowano firmÄ™: ${matchedCompany.name}`, 'success');
                }
            }

            try {
                // LOGIKA TWORZENIA FIRMY "W LOCIE"
                if (typedCompanyName && !selectedCompanyId) {
                    const existing = companies.find(c => c.name && c.name.toLowerCase() === typedCompanyName.toLowerCase());
                    if (existing) {
                        selectedCompanyId = existing.id;
                    } else {
                        let newDomain = '';
                        let newWebsite = '';
                        
                        if (email && email.includes('@')) {
                            const extracted = DataService.extractDomain(email);
                            const publicDomains = ['gmail.com', 'wp.pl', 'onet.pl', 'interia.pl', 'outlook.com', 'yahoo.com'];
                            if (!publicDomains.includes(extracted)) {
                                newDomain = extracted;
                                newWebsite = `https://${extracted}`;
                            }
                        }

                        const newCompany = {
                            id: DataService.generateId(),
                            name: typedCompanyName,
                            industry: '', notes: '', phone: '', city: '', country: '', 
                            domain: newDomain, 
                            website: newWebsite,
                            tags: ''
                        };
                        
                        await DataService.saveCompany(newCompany);
                        companies.push(newCompany);
                        selectedCompanyId = newCompany.id;
                        await DataService.logCompanyHistory(newCompany.id, 'event', 'Firma utworzona (z poziomu kontaktu)');
                        await loadCompanyHistory(); // OdÅ›wieÅ¼ dane
                        showStatus(`Utworzono nowÄ… firmÄ™ "${newCompany.name}"`, 'success');
                        renderCompanies();
                    }
                }

                // Pobierz tagi (Logic from your latest file)
                let tagsIds = '';
                if (typeof getSelectedTagsFromSelector === 'function') {
                    tagsIds = getSelectedTagsFromSelector('contactTagsSelector');
                } else if (editingContactIndex !== null) {
                    tagsIds = contacts[editingContactIndex].tags || '';
                }

                const contact = {
                    id: editingContactIndex !== null ? contacts[editingContactIndex].id : DataService.generateId(),
                    companyId: selectedCompanyId || '',
                    name, position, email, phone,
                    tags: tagsIds
                };

                await DataService.saveContact(contact, editingContactIndex);

                if (editingContactIndex !== null) {
                    contacts[editingContactIndex] = contact;
                    await DataService.logContactHistory(contact.id, 'event', 'Kontakt zaktualizowany');
                    showStatus('Kontakt zaktualizowany', 'success');
                } else {
                    contacts.push(contact);
                    await DataService.logContactHistory(contact.id, 'event', 'Kontakt utworzony');
                    if (contact.companyId) await DataService.logCompanyHistory(contact.companyId, 'event', `Kontakt "${contact.name}" powiÄ…zany z firmÄ…`);
                    showStatus('Kontakt dodany', 'success');
                }

                renderAllContacts();
                renderCompanies();
                if (currentCompanyId) {
                    renderCompanyContacts(currentCompanyId);
                    renderCompanyHistory(currentCompanyId);
                }
                if (currentContactId === contact.id) viewContactDetail(contact.id);
                closeContactModal();
                await loadContactHistory();
            } catch (err) {
                console.error('BÅ‚Ä…d zapisu kontaktu:', err);
                showStatus('BÅ‚Ä…d zapisu kontaktu', 'error');
            }
        }

        async function deleteContact(index) {
            if (!confirm('Czy na pewno chcesz usunÄ…Ä‡ ten kontakt?')) return;
            try {
                const contact = contacts[index];
                await DataService.logContactHistory(contact.id, 'event', 'Kontakt usuniÄ™ty');
                if (contact.companyId) await DataService.logCompanyHistory(contact.companyId, 'event', `Kontakt "${contact.name}" usuniÄ™ty`);
                await DataService.deleteContact(index);

                contacts.splice(index, 1);
                renderAllContacts();
                renderCompanies();
                if (currentCompanyId) {
                    renderCompanyContacts(currentCompanyId);
                    renderCompanyHistory(currentCompanyId);
                }
                if (currentContactId === contact.id) backToContactsList();
                showStatus('Kontakt usuniÄ™ty', 'success');
                await loadContactHistory();
            } catch (err) {
                console.error('BÅ‚Ä…d usuwania kontaktu:', err);
                showStatus('BÅ‚Ä…d usuwania kontaktu', 'error');
            }
        }

        function closeContactModal() {
            document.getElementById('contactModal').classList.remove('active');
            document.getElementById('contactForm').reset();
            hideCompanySuggestions();
            editingContactIndex = null;
        }

        // ============= COMPANY PICKER =============
        function showCompanySuggestions(query) {
            if (!companySuggestionsEl || !companyInputEl) return;
            const q = (query || '').trim().toLowerCase();
            let filtered = q ? companies.filter(c => (c.name || '').toLowerCase().includes(q)) : companies;

            let html = '';
            filtered.slice(0, 8).forEach(c => {
                const meta = [c.industry, c.city].filter(Boolean).join(' â€¢ ');
                html += `<div class="company-suggestion-item" data-id="${c.id}"><span>${escapeHtml(c.name)}</span>${meta ? `<span class="suggestion-meta">${escapeHtml(meta)}</span>` : ''}</div>`;
            });

            const exactExists = companies.some(c => c.name && c.name.toLowerCase() === q && q.length > 0);
            if (q && !exactExists) {
                html += `<div class="company-suggestion-item company-suggestion-new"><span>âž• UtwÃ³rz nowÄ… firmÄ™ "<strong>${escapeHtml(query.trim())}</strong>"</span></div>`;
            }

            if (!html) {
                companySuggestionsEl.innerHTML = '';
                companySuggestionsEl.classList.remove('visible');
                return;
            }

            companySuggestionsEl.innerHTML = html;
            companySuggestionsEl.classList.add('visible');
        }

        function hideCompanySuggestions() {
            if (companySuggestionsEl) {
                companySuggestionsEl.classList.remove('visible');
                companySuggestionsEl.innerHTML = '';
            }
        }

        // ============= HISTORY =============
        function renderCompanyHistory(companyId) {
            const list = document.getElementById('companyHistoryList');
            const empty = document.getElementById('companyHistoryEmpty');
            if (!list || !empty) return;

            const scope = currentCompanyHistoryScope;
            
            // Dla scope 'all' - pobierz aktywnoÅ›ci + notatki (bez events)
            if (scope === 'all') {
                renderCompanyAll(companyId);
                return;
            }
            
            // Dla scope 'activities' - renderuj aktywnoÅ›ci
            if (scope === 'activities') {
                renderCompanyActivities(companyId);
                return;
            }
            
            // Dla scope 'notes' lub 'full'
            const all = companyHistory.filter(h => h.companyId === companyId).sort((a, b) => (b.timestamp || '').localeCompare(a.timestamp || ''));
            const shown = scope === 'notes' ? all.filter(h => h.type === 'note') : all;

            if (shown.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            list.innerHTML = shown.map(entry => `
                <div class="history-item ${entry.type === 'note' ? 'note' : 'event'}">
                    <div class="history-item-header">
                        <span class="history-item-type">${entry.type === 'note' ? 'NOTATKA' : 'ZDARZENIE'}</span>
                        <span class="history-item-meta">${DataService.formatDateTime(entry.timestamp)}${entry.user ? ' â€¢ ' + escapeHtml(formatUserName(entry.user)) : ''}</span>
                    </div>
                    <div class="history-item-body">${escapeHtml(entry.content || '')}</div>
                </div>
            `).join('');
        }

        function renderContactHistory(contactId) {
            const list = document.getElementById('contactHistoryList');
            const empty = document.getElementById('contactHistoryEmpty');
            if (!list || !empty) return;

            const scope = currentContactHistoryScope;
            
            // Dla scope 'all' - pobierz aktywnoÅ›ci + notatki (bez events)
            if (scope === 'all') {
                renderContactAll(contactId);
                return;
            }
            
            // Dla scope 'activities' - renderuj aktywnoÅ›ci
            if (scope === 'activities') {
                renderContactActivities(contactId);
                return;
            }
            
            // Dla scope 'notes' lub 'full'
            const all = contactHistory.filter(h => h.contactId === contactId).sort((a, b) => (b.timestamp || '').localeCompare(a.timestamp || ''));
            const shown = scope === 'notes' ? all.filter(h => h.type === 'note') : all;

            if (shown.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                return;
            }

            empty.style.display = 'none';
            list.innerHTML = shown.map(entry => `
                <div class="history-item ${entry.type === 'note' ? 'note' : 'event'}">
                    <div class="history-item-header">
                        <span class="history-item-type">${entry.type === 'note' ? 'NOTATKA' : 'ZDARZENIE'}</span>
                        <span class="history-item-meta">${DataService.formatDateTime(entry.timestamp)}${entry.user ? ' â€¢ ' + escapeHtml(formatUserName(entry.user)) : ''}</span>
                    </div>
                    <div class="history-item-body">${escapeHtml(entry.content || '')}</div>
                </div>
            `).join('');
        }
/**
         * Renderuj "Wszystko" dla firmy - aktywnoÅ›ci + notatki (bez events)
         */
        function renderCompanyAll(companyId) {
            const list = document.getElementById('companyHistoryList');
            const empty = document.getElementById('companyHistoryEmpty');
            
            // Pobierz aktywnoÅ›ci
            const activities = companyActivities.filter(a => a.companyId === companyId);
            
            // Pobierz notatki (tylko type==='note', bez events)
            const notes = companyHistory.filter(h => h.companyId === companyId && h.type === 'note');
            
            // PoÅ‚Ä…cz i sortuj chronologicznie
            const combined = [
                ...activities.map(a => ({ ...a, itemType: 'activity' })),
                ...notes.map(n => ({ ...n, itemType: 'note' }))
            ].sort((a, b) => {
                const dateA = a.itemType === 'activity' ? a.date : a.timestamp;
                const dateB = b.itemType === 'activity' ? b.date : b.timestamp;
                return (dateB || '').localeCompare(dateA || '');
            });
            
            if (combined.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                empty.querySelector('h3').textContent = 'Brak aktywnoÅ›ci';
                empty.querySelector('p').textContent = 'Nie dodano jeszcze Å¼adnych aktywnoÅ›ci ani notatek.';
                return;
            }
            
            empty.style.display = 'none';
            list.innerHTML = combined.map(item => {
                if (item.itemType === 'activity') {
                    // Render aktywnoÅ›ci
                    const formatted = ActivitiesService.formatActivity(item);
                    return `
                        <div class="activity-item" style="border-left-color: ${formatted.typeColor}">
                            <div class="activity-item-header">
                                <span class="activity-item-icon">${formatted.typeIcon}</span>
                                <span class="activity-item-type">${formatted.typeLabel}</span>
                                <span class="activity-status ${item.status}">${formatted.statusLabel}</span>
                            </div>
                            <div class="activity-item-title">${escapeHtml(formatted.title)}</div>
                            <div class="activity-item-date">${formatted.formattedDate}</div>
                            ${formatted.notes ? `<div class="activity-item-notes">${escapeHtml(formatted.notes)}</div>` : ''}
                            <div class="activity-item-actions">
                                ${item.status === 'planned' ? `<button onclick="completeActivity('${item.id}')">âœ“ UkoÅ„cz</button>` : ''}
                                <button onclick="deleteActivity('${item.id}')">ðŸ—‘ï¸ UsuÅ„</button>
                            </div>
                        </div>
                    `;
                } else {
                    // Render notatki
                    return `
                        <div class="history-item note">
                            <div class="history-item-header">
                                <span class="history-item-type">NOTATKA</span>
                                <span class="history-item-meta">${DataService.formatDateTime(item.timestamp)}${item.user ? ' â€¢ ' + escapeHtml(formatUserName(item.user)) : ''}</span>
                            </div>
                            <div class="history-item-body">${escapeHtml(item.content || '')}</div>
                        </div>
                    `;
                }
            }).join('');
        }

        /**
         * Renderuj "Wszystko" dla kontaktu - aktywnoÅ›ci + notatki (bez events)
         */
        function renderContactAll(contactId) {
            const list = document.getElementById('contactHistoryList');
            const empty = document.getElementById('contactHistoryEmpty');
            
            // Pobierz aktywnoÅ›ci
            const activities = contactActivities.filter(a => a.contactId === contactId);
            
            // Pobierz notatki (tylko type==='note', bez events)
            const notes = contactHistory.filter(h => h.contactId === contactId && h.type === 'note');
            
            // PoÅ‚Ä…cz i sortuj chronologicznie
            const combined = [
                ...activities.map(a => ({ ...a, itemType: 'activity' })),
                ...notes.map(n => ({ ...n, itemType: 'note' }))
            ].sort((a, b) => {
                const dateA = a.itemType === 'activity' ? a.date : a.timestamp;
                const dateB = b.itemType === 'activity' ? b.date : b.timestamp;
                return (dateB || '').localeCompare(dateA || '');
            });
            
            if (combined.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                empty.querySelector('h3').textContent = 'Brak aktywnoÅ›ci';
                empty.querySelector('p').textContent = 'Nie dodano jeszcze Å¼adnych aktywnoÅ›ci ani notatek.';
                return;
            }
            
            empty.style.display = 'none';
            list.innerHTML = combined.map(item => {
                if (item.itemType === 'activity') {
                    // Render aktywnoÅ›ci
                    const formatted = ActivitiesService.formatActivity(item);
                    return `
                        <div class="activity-item" style="border-left-color: ${formatted.typeColor}">
                            <div class="activity-item-header">
                                <span class="activity-item-icon">${formatted.typeIcon}</span>
                                <span class="activity-item-type">${formatted.typeLabel}</span>
                                <span class="activity-status ${item.status}">${formatted.statusLabel}</span>
                            </div>
                            <div class="activity-item-title">${escapeHtml(formatted.title)}</div>
                            <div class="activity-item-date">${formatted.formattedDate}</div>
                            ${formatted.notes ? `<div class="activity-item-notes">${escapeHtml(formatted.notes)}</div>` : ''}
                            <div class="activity-item-actions">
                                ${item.status === 'planned' ? `<button onclick="completeActivity('${item.id}')">âœ“ UkoÅ„cz</button>` : ''}
                                <button onclick="deleteActivity('${item.id}')">ðŸ—‘ï¸ UsuÅ„</button>
                            </div>
                        </div>
                    `;
                } else {
                    // Render notatki
                    return `
                        <div class="history-item note">
                            <div class="history-item-header">
                                <span class="history-item-type">NOTATKA</span>
                                <span class="history-item-meta">${DataService.formatDateTime(item.timestamp)}${item.user ? ' â€¢ ' + escapeHtml(formatUserName(item.user)) : ''}</span>
                            </div>
                            <div class="history-item-body">${escapeHtml(item.content || '')}</div>
                        </div>
                    `;
                }
            }).join('');
        }
        function openNoteModal(entityType, entityId) {
            if (!entityId) {
                showStatus('Najpierw wybierz rekord', 'error');
                return;
            }
            noteEntityTypeEl.value = entityType;
            noteEntityIdEl.value = entityId;
            noteContentEl.value = '';
            document.getElementById('noteModalTitle').textContent = entityType === 'company' ? 'Nowa notatka â€“ firma' : 'Nowa notatka â€“ kontakt';
            document.getElementById('noteModal').classList.add('active');
            noteContentEl.focus();
        }

        function closeNoteModal() {
            document.getElementById('noteModal').classList.remove('active');
            noteContentEl.value = '';
        }

        async function saveNote(e) {
            e.preventDefault();
            const entityType = noteEntityTypeEl.value;
            const entityId = noteEntityIdEl.value;
            const content = noteContentEl.value.trim();
            if (!content) {
                noteContentEl.focus();
                return;
            }

            try {
                if (entityType === 'company') {
                    await DataService.logCompanyHistory(entityId, 'note', content);
                    if (currentCompanyId === entityId) {
                        await loadCompanyHistory();
                        renderCompanyHistory(entityId);
                    }
                } else if (entityType === 'contact') {
                    await DataService.logContactHistory(entityId, 'note', content);
                    if (currentContactId === entityId) {
                        await loadContactHistory();
                        renderContactHistory(entityId);
                    }
                }
                showStatus('Notatka dodana', 'success');
                closeNoteModal();
            } catch (err) {
                console.error('BÅ‚Ä…d dodawania notatki:', err);
                showStatus('BÅ‚Ä…d dodawania notatki', 'error');
            }
        }

        // ============= VIEW SWITCHING =============
        window.switchContactsView = function(mode) {
            contactsViewMode = mode;
            document.querySelectorAll('#contactsTab .view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === mode);
            });
            const grid = document.getElementById('contactsGrid');
            const list = document.getElementById('contactsList');
            if (mode === 'grid') {
                grid.style.display = 'grid';
                list.style.display = 'none';
            } else {
                grid.style.display = 'none';
                list.style.display = 'block';
            }
            renderAllContacts();
        };

        window.switchCompaniesView = function(mode) {
            companiesViewMode = mode;
            document.querySelectorAll('#companiesListView .view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === mode);
            });
            const grid = document.getElementById('companiesGrid');
            const list = document.getElementById('companiesList');
            if (mode === 'grid') {
                grid.style.display = 'grid';
                list.style.display = 'none';
            } else {
                grid.style.display = 'none';
                list.style.display = 'block';
            }
            renderCompanies();
        };

        // ============= HELPERS =============
        function showStatus(message, type) {
            const msg = document.createElement('div');
            msg.className = 'status-message' + (type ? ' ' + type : '');
            msg.textContent = message;
            document.body.appendChild(msg);
            setTimeout(() => msg.remove(), 3200);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text == null ? '' : text;
            return div.innerHTML;
        }

        // ============= USER PREFERENCES =============
        async function loadUserPreferences(email) {
            try {
                const prefs = await DataService.loadUserPreferences(email);
                if (prefs && prefs.displayName) {
                    AuthService.saveDisplayName(prefs.displayName);
                    console.log('âœ“ ZaÅ‚adowano preferencje uÅ¼ytkownika:', prefs.displayName);
                }
            } catch (error) {
                console.warn('Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ preferencji uÅ¼ytkownika:', error);
                // Nie blokuj dziaÅ‚ania aplikacji
            }
        }

        /**
         * Konwertuje email na display name jeÅ›li to jest aktualny uÅ¼ytkownik
         */
        function formatUserName(userName) {
            if (!userName) return '';
            
            const currentEmail = AuthService.getUserEmail();
            const displayName = AuthService.getDisplayName();
            
            // JeÅ›li userName to email aktualnego uÅ¼ytkownika i mamy display name
            if (userName === currentEmail && displayName) {
                return displayName;
            }
            
            // JeÅ›li userName to email aktualnego uÅ¼ytkownika ale nie ma display name
            if (userName === currentEmail) {
                return currentEmail.split('@')[0];
            }
            
            // Dla innych uÅ¼ytkownikÃ³w - zwrÃ³Ä‡ jak jest (moÅ¼e byÄ‡ email lub juÅ¼ display name)
            return userName;
        }

// ============= ACTIVITIES =============

        async function loadActivitiesData() {
            try {
                companyActivities = await DataService.loadActivities();
                contactActivities = companyActivities;
                console.log('âœ“ AktywnoÅ›ci zaÅ‚adowane:', companyActivities.length);
            } catch (error) {
                console.warn('Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ aktywnoÅ›ci:', error);
                companyActivities = [];
                contactActivities = [];
            }
        }

        function openActivityModal(entityType, entityId) {
            if (!entityId) {
                showStatus('Najpierw wybierz rekord', 'error');
                return;
            }
            
            document.getElementById('activityEntityType').value = entityType;
            document.getElementById('activityEntityId').value = entityId;
            document.getElementById('activityType').value = 'EMAIL';
            currentActivityType = 'EMAIL';
            
            // Reset form
            document.getElementById('activityForm').reset();
            document.getElementById('activityTitle').value = '';
            document.getElementById('activityNotes').value = '';
            
            // Set default date (now)
            const now = new Date();
            const localDateTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
                .toISOString()
                .slice(0, 16);
            document.getElementById('activityDate').value = localDateTime;
            
            // Show/hide contact selector
            const contactSelectorGroup = document.getElementById('activityContactSelectorGroup');
            if (entityType === 'company') {
                const companyContacts = contacts.filter(c => c.companyId === entityId);
                const select = document.getElementById('activityContactSelect');
                select.innerHTML = '<option value="">Tylko firma</option>' +
                    companyContacts.map(c => `<option value="${c.id}">${escapeHtml(c.name)}</option>`).join('');
                contactSelectorGroup.style.display = 'block';
            } else {
                contactSelectorGroup.style.display = 'none';
            }
            
            document.getElementById('activityModal').classList.add('active');
            document.getElementById('activityTitle').focus();
        }

        function closeActivityModal() {
            document.getElementById('activityModal').classList.remove('active');
            document.getElementById('activityForm').reset();
        }

        async function saveActivity(e) {
            e.preventDefault();
            
            const entityType = document.getElementById('activityEntityType').value;
            const entityId = document.getElementById('activityEntityId').value;
            const type = currentActivityType;
            const title = document.getElementById('activityTitle').value;
            const date = document.getElementById('activityDate').value;
            const notes = document.getElementById('activityNotes').value;
            
            let companyId = '';
            let contactId = '';
            
            if (entityType === 'company') {
                companyId = entityId;
                const selectedContactId = document.getElementById('activityContactSelect').value;
                if (selectedContactId) {
                    contactId = selectedContactId;
                }
            } else if (entityType === 'contact') {
                contactId = entityId;
                const contact = contacts.find(c => c.id === contactId);
                if (contact && contact.companyId) {
                    companyId = contact.companyId;
                }
            }
            
            try {
                await ActivitiesService.createActivity({
                    type,
                    title,
                    date: new Date(date).toISOString(),
                    notes,
                    companyId,
                    contactId,
                    status: 'planned'
                });
                
                showStatus('AktywnoÅ›Ä‡ dodana', 'success');
                
                await loadActivitiesData();
                
                if (currentCompanyId) {
                    renderCompanyActivities(currentCompanyId);
                    await loadCompanyHistory();
                    renderCompanyHistory(currentCompanyId);
                }
                
                if (currentContactId) {
                    renderContactActivities(currentContactId);
                    await loadContactHistory();
                    renderContactHistory(currentContactId);
                }
                
                closeActivityModal();
            } catch (error) {
                console.error('BÅ‚Ä…d zapisu aktywnoÅ›ci:', error);
                showStatus('BÅ‚Ä…d zapisu: ' + error.message, 'error');
            }
        }

        function renderCompanyActivities(companyId) {
            const list = document.getElementById('companyHistoryList');
            const empty = document.getElementById('companyHistoryEmpty');
            if (!list || !empty) return;
            
            const activities = companyActivities.filter(a => a.companyId === companyId);
            
            if (activities.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                empty.querySelector('h3').textContent = 'Brak aktywnoÅ›ci';
                empty.querySelector('p').textContent = 'Nie dodano jeszcze Å¼adnych aktywnoÅ›ci dla tej firmy.';
                return;
            }
            
            empty.style.display = 'none';
            list.innerHTML = activities
                .sort((a, b) => b.date.localeCompare(a.date))
                .map(activity => {
                    const formatted = ActivitiesService.formatActivity(activity);
                    return `
                        <div class="activity-item" style="border-left-color: ${formatted.typeColor}">
                            <div class="activity-item-header">
                                <span class="activity-item-icon">${formatted.typeIcon}</span>
                                <span class="activity-item-type">${formatted.typeLabel}</span>
                                <span class="activity-status ${activity.status}">${formatted.statusLabel}</span>
                            </div>
                            <div class="activity-item-title">${escapeHtml(formatted.title)}</div>
                            <div class="activity-item-date">${formatted.formattedDate}</div>
                            ${formatted.notes ? `<div class="activity-item-notes">${escapeHtml(formatted.notes)}</div>` : ''}
                            <div class="activity-item-actions">
                                ${activity.status === 'planned' ? `<button onclick="completeActivity('${activity.id}')">âœ“ UkoÅ„cz</button>` : ''}
                                <button onclick="deleteActivity('${activity.id}')">ðŸ—‘ï¸ UsuÅ„</button>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        function renderContactActivities(contactId) {
            const list = document.getElementById('contactHistoryList');
            const empty = document.getElementById('contactHistoryEmpty');
            if (!list || !empty) return;
            
            const activities = contactActivities.filter(a => a.contactId === contactId);
            
            if (activities.length === 0) {
                list.innerHTML = '';
                empty.style.display = 'block';
                empty.querySelector('h3').textContent = 'Brak aktywnoÅ›ci';
                empty.querySelector('p').textContent = 'Nie dodano jeszcze Å¼adnych aktywnoÅ›ci dla tego kontaktu.';
                return;
            }
            
            empty.style.display = 'none';
            list.innerHTML = activities
                .sort((a, b) => b.date.localeCompare(a.date))
                .map(activity => {
                    const formatted = ActivitiesService.formatActivity(activity);
                    return `
                        <div class="activity-item" style="border-left-color: ${formatted.typeColor}">
                            <div class="activity-item-header">
                                <span class="activity-item-icon">${formatted.typeIcon}</span>
                                <span class="activity-item-type">${formatted.typeLabel}</span>
                                <span class="activity-status ${activity.status}">${formatted.statusLabel}</span>
                            </div>
                            <div class="activity-item-title">${escapeHtml(formatted.title)}</div>
                            <div class="activity-item-date">${formatted.formattedDate}</div>
                            ${formatted.notes ? `<div class="activity-item-notes">${escapeHtml(formatted.notes)}</div>` : ''}
                            <div class="activity-item-actions">
                                ${activity.status === 'planned' ? `<button onclick="completeActivity('${activity.id}')">âœ“ UkoÅ„cz</button>` : ''}
                                <button onclick="deleteActivity('${activity.id}')">ðŸ—‘ï¸ UsuÅ„</button>
                            </div>
                        </div>
                    `;
                }).join('');
        }

        async function completeActivity(activityId) {
            try {
                await ActivitiesService.completeActivity(activityId);
                showStatus('AktywnoÅ›Ä‡ ukoÅ„czona', 'success');
                
                await loadActivitiesData();
                
                if (currentCompanyId) renderCompanyActivities(currentCompanyId);
                if (currentContactId) renderContactActivities(currentContactId);
            } catch (error) {
                console.error('BÅ‚Ä…d:', error);
                showStatus('BÅ‚Ä…d: ' + error.message, 'error');
            }
        }

        async function deleteActivity(activityId) {
            if (!confirm('Czy na pewno chcesz usunÄ…Ä‡ tÄ™ aktywnoÅ›Ä‡?')) return;
            
            try {
                await ActivitiesService.deleteActivity(activityId);
                showStatus('AktywnoÅ›Ä‡ usuniÄ™ta', 'success');
                
                await loadActivitiesData();
                
                if (currentCompanyId) {
                    renderCompanyActivities(currentCompanyId);
                    await loadCompanyHistory();
                    renderCompanyHistory(currentCompanyId);
                }
                
                if (currentContactId) {
                    renderContactActivities(currentContactId);
                    await loadContactHistory();
                    renderContactHistory(currentContactId);
                }
            } catch (error) {
                console.error('BÅ‚Ä…d:', error);
                showStatus('BÅ‚Ä…d: ' + error.message, 'error');
            }
        }
        
        // ============= TAGS JAVASCRIPT =============
// Ten kod naleÅ¼y dodaÄ‡ do relationships.html w sekcji 
// ========== TAGS MANAGER MODAL ==========

function openTagsManager(initialType = 'companies') {
    currentTagType = initialType;
    renderColorPickers();
    renderCompanyTagsList();
    renderContactTagsList();
    switchTagsTab(initialType);
    document.getElementById('tagsManagerModal').classList.add('active');
}

function closeTagsManager() {
    document.getElementById('tagsManagerModal').classList.remove('active');
    resetCompanyTagForm();
    resetContactTagForm();
}

function switchTagsTab(type) {
    currentTagType = type;
    
    // Update tabs
    document.querySelectorAll('.tags-modal-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.type === type);
    });
    
    // Update sections
    document.getElementById('companiesTagsSection').style.display = 
        type === 'companies' ? 'block' : 'none';
    document.getElementById('contactsTagsSection').style.display = 
        type === 'contacts' ? 'block' : 'none';
}

// ========== COLOR PICKER ==========

function renderColorPickers() {
    const colors = CONFIG.TAGS.DEFAULT_COLORS;
    
    // Company tags color picker
    const companyPicker = document.getElementById('companyTagColorPicker');
    companyPicker.innerHTML = colors.map(color => `
        <div class="color-option" 
             style="background-color: ${color}" 
             data-color="${color}"
             onclick="selectColor('company', '${color}')">
        </div>
    `).join('');
    
    // Contact tags color picker
    const contactPicker = document.getElementById('contactTagColorPicker');
    contactPicker.innerHTML = colors.map(color => `
        <div class="color-option" 
             style="background-color: ${color}" 
             data-color="${color}"
             onclick="selectColor('contact', '${color}')">
        </div>
    `).join('');
    
    // Select default color
    selectColor('company', '#3b82f6');
    selectColor('contact', '#3b82f6');
}

function selectColor(type, color) {
    const pickerId = type === 'company' ? 'companyTagColorPicker' : 'contactTagColorPicker';
    const inputId = type === 'company' ? 'companyTagColor' : 'contactTagColor';
    
    // Update hidden input
    document.getElementById(inputId).value = color;
    
    // Update visual selection
    const picker = document.getElementById(pickerId);
    picker.querySelectorAll('.color-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.color === color);
    });
}

// ========== COMPANY TAGS ==========

async function saveCompanyTag(event) {
    event.preventDefault();
    
    const tagId = document.getElementById('companyTagId').value;
    const rowIndex = document.getElementById('companyTagRowIndex').value;
    
    const tag = {
        id: tagId || DataService.generateId(),
        name: document.getElementById('companyTagName').value.trim(),
        color: document.getElementById('companyTagColor').value,
        description: document.getElementById('companyTagDescription').value.trim()
    };
    
    try {
        await DataService.saveCompanyTag(tag, rowIndex ? parseInt(rowIndex) : null);
        showStatus(tagId ? 'Etykieta zaktualizowana' : 'Etykieta dodana', 'success');
        
        // Reload
        await loadTagsData();
        renderCompanyTagsList();
        renderCompanies();
        
        // Reset form
        resetCompanyTagForm();
    } catch (error) {
        console.error('Error saving company tag:', error);
        showStatus('BÅ‚Ä…d przy zapisie etykiety', 'error');
    }
}

function resetCompanyTagForm() {
    document.getElementById('companyTagForm').reset();
    document.getElementById('companyTagId').value = '';
    document.getElementById('companyTagRowIndex').value = '';
    document.getElementById('companyTagSubmitText').textContent = 'Dodaj etykietÄ™';
    selectColor('company', '#3b82f6');
}

function editCompanyTag(tag, rowIndex) {
    document.getElementById('companyTagId').value = tag.id;
    document.getElementById('companyTagRowIndex').value = rowIndex;
    document.getElementById('companyTagName').value = tag.name;
    document.getElementById('companyTagDescription').value = tag.description || '';
    document.getElementById('companyTagSubmitText').textContent = 'Zapisz zmiany';
    selectColor('company', tag.color);
    
    // Scroll to form
    document.querySelector('#companiesTagsSection .tag-form-section').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

async function deleteCompanyTag(tagId, rowIndex) {
    if (!confirm('Czy na pewno chcesz usunÄ…Ä‡ tÄ™ etykietÄ™? Zostanie ona usuniÄ™ta ze wszystkich firm.')) {
        return;
    }
    
    try {
        await DataService.deleteCompanyTag(rowIndex);
        showStatus('Etykieta usuniÄ™ta', 'success');
        
        // Reload
        await loadTagsData();
        renderCompanyTagsList();
        renderCompanies();
    } catch (error) {
        console.error('Error deleting company tag:', error);
        showStatus('BÅ‚Ä…d przy usuwaniu etykiety', 'error');
    }
}

function renderCompanyTagsList() {
    const container = document.getElementById('companyTagsList');
    
    if (!companyTags || companyTags.length === 0) {
        container.innerHTML = `
            <div class="empty-state small">
                <p>Brak etykiet dla firm. Dodaj pierwszÄ… etykietÄ™ uÅ¼ywajÄ…c formularza powyÅ¼ej.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = companyTags.map((tag, index) => `
        <div class="tag-list-item">
            <div class="tag-list-item-left">
                <div class="tag-list-item-color" style="background-color: ${tag.color}"></div>
                <div class="tag-list-item-info">
                    <div class="tag-list-item-name">${escapeHtml(tag.name)}</div>
                    ${tag.description ? `<div class="tag-list-item-desc">${escapeHtml(tag.description)}</div>` : ''}
                </div>
            </div>
            <div class="tag-list-item-actions">
                <button class="tag-action-btn" onclick='editCompanyTag(${JSON.stringify(tag)}, ${index})' title="Edytuj">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
                <button class="tag-action-btn" onclick="deleteCompanyTag('${tag.id}', ${index})" title="UsuÅ„">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
        </div>
    `).join('');
}

// ========== CONTACT TAGS ==========

async function saveContactTag(event) {
    event.preventDefault();
    
    const tagId = document.getElementById('contactTagId').value;
    const rowIndex = document.getElementById('contactTagRowIndex').value;
    
    const tag = {
        id: tagId || DataService.generateId(),
        name: document.getElementById('contactTagName').value.trim(),
        color: document.getElementById('contactTagColor').value,
        description: document.getElementById('contactTagDescription').value.trim()
    };
    
    try {
        await DataService.saveContactTag(tag, rowIndex ? parseInt(rowIndex) : null);
        showStatus(tagId ? 'Etykieta zaktualizowana' : 'Etykieta dodana', 'success');
        
        // Reload
        await loadTagsData();
        renderContactTagsList();
        renderAllContacts();
        
        // Reset form
        resetContactTagForm();
    } catch (error) {
        console.error('Error saving contact tag:', error);
        showStatus('BÅ‚Ä…d przy zapisie etykiety', 'error');
    }
}

function resetContactTagForm() {
    document.getElementById('contactTagForm').reset();
    document.getElementById('contactTagId').value = '';
    document.getElementById('contactTagRowIndex').value = '';
    document.getElementById('contactTagSubmitText').textContent = 'Dodaj etykietÄ™';
    selectColor('contact', '#3b82f6');
}

function editContactTag(tag, rowIndex) {
    document.getElementById('contactTagId').value = tag.id;
    document.getElementById('contactTagRowIndex').value = rowIndex;
    document.getElementById('contactTagName').value = tag.name;
    document.getElementById('contactTagDescription').value = tag.description || '';
    document.getElementById('contactTagSubmitText').textContent = 'Zapisz zmiany';
    selectColor('contact', tag.color);
    
    // Scroll to form
    document.querySelector('#contactsTagsSection .tag-form-section').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
    });
}

async function deleteContactTag(tagId, rowIndex) {
    if (!confirm('Czy na pewno chcesz usunÄ…Ä‡ tÄ™ etykietÄ™? Zostanie ona usuniÄ™ta ze wszystkich kontaktÃ³w.')) {
        return;
    }
    
    try {
        await DataService.deleteContactTag(rowIndex);
        showStatus('Etykieta usuniÄ™ta', 'success');
        
        // Reload
        await loadTagsData();
        renderContactTagsList();
        renderAllContacts();
    } catch (error) {
        console.error('Error deleting contact tag:', error);
        showStatus('BÅ‚Ä…d przy usuwaniu etykiety', 'error');
    }
}

function renderContactTagsList() {
    const container = document.getElementById('contactTagsList');
    
    if (!contactTags || contactTags.length === 0) {
        container.innerHTML = `
            <div class="empty-state small">
                <p>Brak etykiet dla osÃ³b. Dodaj pierwszÄ… etykietÄ™ uÅ¼ywajÄ…c formularza powyÅ¼ej.</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = contactTags.map((tag, index) => `
        <div class="tag-list-item">
            <div class="tag-list-item-left">
                <div class="tag-list-item-color" style="background-color: ${tag.color}"></div>
                <div class="tag-list-item-info">
                    <div class="tag-list-item-name">${escapeHtml(tag.name)}</div>
                    ${tag.description ? `<div class="tag-list-item-desc">${escapeHtml(tag.description)}</div>` : ''}
                </div>
            </div>
            <div class="tag-list-item-actions">
                <button class="tag-action-btn" onclick='editContactTag(${JSON.stringify(tag)}, ${index})' title="Edytuj">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                    </svg>
                </button>
                <button class="tag-action-btn" onclick="deleteContactTag('${tag.id}', ${index})" title="UsuÅ„">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                    </svg>
                </button>
            </div>
        </div>
    `).join('');
}

// ========== TAG FILTERING ==========

function filterByTag(tagId, tagName, tagColor, type) {
    currentTagFilter = { id: tagId, name: tagName, color: tagColor, type: type };
    
    if (type === 'company') {
        renderCompanies();
    } else {
        renderAllContacts();
    }
}

function clearTagFilter() {
    currentTagFilter = null;
    renderCompanies();
    renderAllContacts();
}

// ========== RENDER TAGS IN VIEWS ==========

function renderEntityTags(entityId, type) {
    const tags = type === 'company' 
        ? DataService.getCompanyTags(entityId, companyTags, companyTagRelations)
        : DataService.getContactTags(entityId, contactTags, contactTagRelations);
    
    if (!tags || tags.length === 0) return '';
    
    // Render minimal color bars for cards
    return `
        <div class="tags-container">
            ${tags.map(tag => `
                <div class="tag-badge" 
                     style="background-color: ${tag.color}"
                     data-tag-name="${escapeHtml(tag.name)}"
                     title="${escapeHtml(tag.description || tag.name)}">
                </div>
            `).join('')}
        </div>
    `;
}

// ========== ASSIGN/REMOVE TAGS ==========

async function assignTagToEntity(entityId, tagId, type) {
    try {
        if (type === 'company') {
            await DataService.assignTagToCompany(entityId, tagId);
        } else {
            await DataService.assignTagToContact(entityId, tagId);
        }
        
        showStatus('Etykieta przypisana', 'success');
        
        // Reload
        await loadTagsData();
        
        // Refresh current view
        if (type === 'company' && currentCompanyId === entityId) {
            viewCompanyDetail(entityId);
        } else if (type === 'contact' && currentContactId === entityId) {
            viewContactDetail(entityId);
        }
    } catch (error) {
        console.error('BÅ‚Ä…d przypisywania etykiety:', error);
        showStatus('BÅ‚Ä…d przypisywania etykiety', 'error');
    }
}

/**
 * Render tags in detail view (inline with other info)
 */
function renderDetailTags(entityId, type) {
    const allTags = type === 'company' ? companyTags : contactTags;
    const allRelations = type === 'company' ? companyTagRelations : contactTagRelations;
    
    const entityTags = type === 'company' 
        ? DataService.getCompanyTags(entityId, allTags, allRelations)
        : DataService.getContactTags(entityId, allTags, allRelations);
    
    const availableTags = allTags.filter(tag => 
        !entityTags.find(et => et.id === tag.id)
    );
    
    const dropdownId = type === 'company' ? 'companyTagDropdown' : 'contactTagDropdown';
    const addBtnId = type === 'company' ? 'addCompanyTagBtn' : 'addContactTagBtn';
    
    return `
        <div class="detail-info-row">
            <div class="detail-info-label">Etykiety</div>
            <div class="detail-info-value" style="position: relative;">
                <div class="detail-tags-inline">
                    ${entityTags.length > 0 ? entityTags.map(tag => `
                        <div class="detail-tag-item" style="background-color: ${tag.color}">
                            ${escapeHtml(tag.name)}
                            <button 
                                class="remove-tag-btn" 
                                onclick="event.stopPropagation(); removeTagFromDetail('${entityId}', '${tag.id}', '${type}')"
                                title="UsuÅ„">Ã—</button>
                        </div>
                    `).join('') : '<span style="color: var(--text-secondary); font-style: italic; font-size: 0.85rem;">Brak etykiet</span>'}
                    
                    <button class="add-tag-btn" id="${addBtnId}" title="Dodaj etykietÄ™">+</button>
                </div>
                
                <!-- Dropdown for adding tags -->
                <div class="tag-dropdown" id="${dropdownId}">
                    ${availableTags.length > 0 ? availableTags.map(tag => `
                        <div class="tag-dropdown-item" onclick="quickAssignTag('${entityId}', '${tag.id}', '${type}')">
                            <div class="tag-dropdown-color" style="background-color: ${tag.color}"></div>
                            <span>${escapeHtml(tag.name)}</span>
                        </div>
                    `).join('') : '<div class="tag-dropdown-empty">Wszystkie etykiety przypisane</div>'}
                </div>
            </div>
        </div>
    `;
}

/**
 * Quick assign tag from dropdown
 */
async function quickAssignTag(entityId, tagId, type) {
    try {
        // Find tag name for logging
        const allTags = type === 'company' ? companyTags : contactTags;
        const tag = allTags.find(t => t.id === tagId);
        const tagName = tag ? tag.name : 'etykieta';
        
        await assignTagToEntity(entityId, tagId, type);
        
        // Log to history
        if (type === 'company') {
            await DataService.logCompanyHistory(entityId, 'event', `Dodano etykietÄ™: ${tagName}`);
        } else {
            await DataService.logContactHistory(entityId, 'event', `Dodano etykietÄ™: ${tagName}`);
        }
        
        // Reload tags and history
        await loadTagsData();
        if (type === 'company') {
            await loadCompanyHistory();
            viewCompanyDetail(entityId);
            renderCompanyHistory(entityId);
        } else {
            await loadContactHistory();
            viewContactDetail(entityId);
            renderContactHistory(entityId);
        }
        
        showStatus('Etykieta przypisana', 'success');
    } catch (error) {
        console.error('BÅ‚Ä…d przypisywania etykiety:', error);
        showStatus('BÅ‚Ä…d przypisywania etykiety', 'error');
    }
}

/**
 * Toggle tag dropdown visibility
 */
function toggleTagDropdown(dropdownId, buttonId) {
    const dropdown = document.getElementById(dropdownId);
    const button = document.getElementById(buttonId);
    
    if (!dropdown || !button) return;
    
    const isVisible = dropdown.classList.contains('visible');
    
    // Close all other dropdowns
    document.querySelectorAll('.tag-dropdown').forEach(dd => {
        dd.classList.remove('visible');
    });
    
    // Toggle this dropdown
    if (!isVisible) {
        dropdown.classList.add('visible');
        
        // Close on click outside
        setTimeout(() => {
            const closeOnClickOutside = (e) => {
                if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                    dropdown.classList.remove('visible');
                    document.removeEventListener('click', closeOnClickOutside);
                }
            };
            document.addEventListener('click', closeOnClickOutside);
        }, 10);
    }
}

/**
 * Remove tag from entity in detail view
 */
async function removeTagFromDetail(entityId, tagId, type) {
    if (!confirm('Czy na pewno chcesz usunÄ…Ä‡ tÄ™ etykietÄ™?')) {
        return;
    }
    
    try {
        // Find tag name for logging
        const allTags = type === 'company' ? companyTags : contactTags;
        const tag = allTags.find(t => t.id === tagId);
        const tagName = tag ? tag.name : 'etykieta';
        
        // Remove tag
        await removeTagFromEntity(entityId, tagId, type);
        
        // Log to history
        if (type === 'company') {
            await DataService.logCompanyHistory(entityId, 'event', `UsuniÄ™to etykietÄ™: ${tagName}`);
        } else {
            await DataService.logContactHistory(entityId, 'event', `UsuniÄ™to etykietÄ™: ${tagName}`);
        }
        
        // Reload tags
        await loadTagsData();
        
        // Reload history
        if (type === 'company') {
            await loadCompanyHistory();
            viewCompanyDetail(entityId);
            renderCompanyHistory(entityId);
        } else {
            await loadContactHistory();
            viewContactDetail(entityId);
            renderContactHistory(entityId);
        }
        
        showStatus('Etykieta usuniÄ™ta', 'success');
    } catch (error) {
        console.error('BÅ‚Ä…d usuwania etykiety:', error);
        showStatus('BÅ‚Ä…d usuwania etykiety', 'error');
    }
}

async function removeTagFromEntity(entityId, tagId, type) {
    try {
        // Reload relations from sheet to get accurate row indices
        let allRelationsFromSheet;
        if (type === 'company') {
            allRelationsFromSheet = await DataService.loadCompanyTagRelations(null, false);
        } else {
            allRelationsFromSheet = await DataService.loadContactTagRelations(null, false);
        }
        
        // Find relation in fresh data
        const relation = allRelationsFromSheet.find(r => 
            (type === 'company' ? r.companyId : r.contactId) === entityId && r.tagId === tagId
        );
        
        if (!relation) {
            showStatus('Nie znaleziono relacji', 'error');
            return;
        }
        
        // Row index is position in array (0-based)
        // DataService will add +2 for header row
        const rowIndex = allRelationsFromSheet.indexOf(relation);
        
        if (type === 'company') {
            await DataService.removeTagFromCompany(relation.id, rowIndex);
        } else {
            await DataService.removeTagFromContact(relation.id, rowIndex);
        }
        
        // Reload local cache
        await loadTagsData();
        
        console.log('âœ“ Tag removed successfully');
    } catch (error) {
        console.error('Error removing tag:', error);
        throw error; // Re-throw to be caught by caller
    }
}

// ========== LOAD TAGS DATA ==========

async function loadTagsData() {
    try {
        [companyTags, contactTags, companyTagRelations, contactTagRelations] = await Promise.all([
            DataService.loadCompanyTags(),
            DataService.loadContactTags(),
            DataService.loadCompanyTagRelations(),
            DataService.loadContactTagRelations()
        ]);
        console.log('âœ“ Etykiety zaÅ‚adowane:', {
            companyTags: companyTags.length,
            contactTags: contactTags.length,
            companyRelations: companyTagRelations.length,
            contactRelations: contactTagRelations.length
        });
    } catch (error) {
        console.error('Error loading tags:', error);
    }
}


        

        
        // ============= MAKE FUNCTIONS GLOBAL =============
        // Make all functions available for onclick handlers
        
        // Basic functions
        window.viewCompanyDetail = viewCompanyDetail;
        window.viewContactDetail = viewContactDetail;
        window.editCompany = editCompany;
        window.editContact = editContact;
        window.deleteCompany = deleteCompany;
        window.deleteContact = deleteContact;
        window.editCompanyFromDetail = editCompanyFromDetail;
        window.editContactFromDetail = editContactFromDetail;
        window.closeDuplicateModal = () => document.getElementById('duplicateModal').classList.remove('active');
        
        // ============= EXPOSE FUNCTIONS TO WINDOW =============
        // To jest konieczne, aby przyciski w HTML (onclick=...) widziaÅ‚y te funkcje
        
        // Tags functions
        window.openTagsManager = openTagsManager;
        window.closeTagsManager = closeTagsManager;
        window.switchTagsTab = switchTagsTab;
        window.selectColor = selectColor;
        window.saveCompanyTag = saveCompanyTag;
        window.editCompanyTag = editCompanyTag;
        window.deleteCompanyTag = deleteCompanyTag;
        window.saveContactTag = saveContactTag;
        window.editContactTag = editContactTag;
        window.deleteContactTag = deleteContactTag;
        window.filterByTag = filterByTag;
        window.renderDetailTags = renderDetailTags;
        window.quickAssignTag = quickAssignTag;
        window.toggleTagDropdown = toggleTagDropdown;
        window.removeTagFromDetail = removeTagFromDetail;
        window.openActivityModal = openActivityModal;
        window.completeActivity = completeActivity;
        window.deleteActivity = deleteActivity;


        // ============= EVENT LISTENERS =============
        document.addEventListener('DOMContentLoaded', () => {
            // Logout
            document.getElementById('logoutBtn').addEventListener('click', () => {
                if (confirm('Czy na pewno chcesz siÄ™ wylogowaÄ‡?')) {
                    AuthService.logout();
                }
            });

            // Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (btn.dataset.tab === 'contacts') backToContactsList();
                    else if (btn.dataset.tab === 'companies') backToCompaniesList();
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(btn.dataset.tab + 'Tab').classList.add('active');
                });
            });

            // Search
            const globalSearchInput = document.getElementById('globalSearchInput');
            const clearSearchBtn = document.getElementById('clearSearchBtn');
            if (globalSearchInput) {
                globalSearchInput.addEventListener('input', (e) => {
                    currentSearchTerm = e.target.value || '';
                    renderAllContacts();
                    renderCompanies();
                    if (currentCompanyId) renderCompanyContacts(currentCompanyId);
                });
            }
            if (clearSearchBtn) {
                clearSearchBtn.addEventListener('click', () => {
                    currentSearchTerm = '';
                    if (globalSearchInput) globalSearchInput.value = '';
                    renderAllContacts();
                    renderCompanies();
                });
            }

            // Companies
            document.getElementById('addCompanyBtn').addEventListener('click', openCompanyModal);
            document.getElementById('closeCompanyModalBtn').addEventListener('click', closeCompanyModal);
            document.getElementById('cancelCompanyBtn').addEventListener('click', closeCompanyModal);
            document.getElementById('companyForm').addEventListener('submit', saveCompany);
            document.getElementById('backToCompaniesBtn').addEventListener('click', backToCompaniesList);

            // Contacts
            document.getElementById('addContactBtn').addEventListener('click', () => openContactModal());
            document.getElementById('addCompanyContactBtn').addEventListener('click', () => openContactModal(currentCompanyId));
            document.getElementById('closeContactModalBtn').addEventListener('click', closeContactModal);
            document.getElementById('cancelContactBtn').addEventListener('click', closeContactModal);
            document.getElementById('contactForm').addEventListener('submit', saveContact);
            document.getElementById('backToContactsBtn').addEventListener('click', backToContactsList);

            // Company picker
            companyInputEl = document.getElementById('contactCompanyInput');
            companyIdEl = document.getElementById('contactCompanyId');
            companySuggestionsEl = document.getElementById('companySuggestions');

            if (companyInputEl) {
                const onInput = () => {
                    companyIdEl.value = '';
                    showCompanySuggestions(companyInputEl.value);
                };
                companyInputEl.addEventListener('input', onInput);
                companyInputEl.addEventListener('focus', onInput);
            }

            if (companySuggestionsEl) {
                companySuggestionsEl.addEventListener('click', (e) => {
                    const item = e.target.closest('.company-suggestion-item');
                    if (!item) return;
                    if (item.dataset.id) {
                        const company = companies.find(c => c.id === item.dataset.id);
                        if (company) {
                            companyInputEl.value = company.name;
                            companyIdEl.value = company.id;
                        }
                    }
                    hideCompanySuggestions();
                });
            }

            // Auto-match company by email domain
            const contactEmailEl = document.getElementById('contactEmail');
            if (contactEmailEl && companyInputEl && companyIdEl) {
                contactEmailEl.addEventListener('blur', () => {
                    const email = contactEmailEl.value.trim();
                    if (!email || !email.includes('@')) return;
                    if (companyInputEl.value.trim() || companyIdEl.value) return;
                    const domain = DataService.extractDomain(email);
                    const matchedCompany = DataService.findCompanyByDomain(companies, domain);
                    if (matchedCompany) {
                        companyInputEl.value = matchedCompany.name;
                        companyIdEl.value = matchedCompany.id;
                        showStatus(`ðŸŽ¯ Auto-dopasowano firmÄ™: ${matchedCompany.name}`, 'success');
                    }
                });
            }

            // Note modal
            noteEntityTypeEl = document.getElementById('noteEntityType');
            noteEntityIdEl = document.getElementById('noteEntityId');
            noteContentEl = document.getElementById('noteContent');

            document.getElementById('closeNoteModalBtn').addEventListener('click', closeNoteModal);
            document.getElementById('cancelNoteBtn').addEventListener('click', closeNoteModal);
            document.getElementById('noteForm').addEventListener('submit', saveNote);

            document.getElementById('addCompanyNoteBtn').addEventListener('click', () => openNoteModal('company', currentCompanyId));
            document.getElementById('addContactNoteBtn').addEventListener('click', () => openNoteModal('contact', currentContactId));

            // History tabs
document.querySelectorAll('.history-tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        const entity = btn.dataset.entity;
        const scope = btn.dataset.scope;
        document.querySelectorAll(`.history-tab-btn[data-entity="${entity}"]`).forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if (entity === 'company') {
            currentCompanyHistoryScope = scope;
            if (currentCompanyId) {
                if (scope === 'activities') {
                    renderCompanyActivities(currentCompanyId);
                } else {
                    renderCompanyHistory(currentCompanyId);
                }
            }
        } else if (entity === 'contact') {
            currentContactHistoryScope = scope;
            if (currentContactId) {
                if (scope === 'activities') {
                    renderContactActivities(currentContactId);
                } else {
                    renderContactHistory(currentContactId);
                }
            }
        }
    });
});

            // Close modals on background click
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) modal.classList.remove('active');
                });
            });

            // Hide company suggestions when clicking outside
            document.addEventListener('click', (e) => {
                if (companyInputEl && companyInputEl.closest('.company-picker') && companySuggestionsEl) {
                    if (!companyInputEl.closest('.company-picker').contains(e.target)) {
                        hideCompanySuggestions();
                    }
                }
            });
        });
// Activity modal
            document.getElementById('closeActivityModalBtn').addEventListener('click', closeActivityModal);
            document.getElementById('cancelActivityBtn').addEventListener('click', closeActivityModal);
            document.getElementById('activityForm').addEventListener('submit', saveActivity);
            document.getElementById('addCompanyActivityBtn').addEventListener('click', () => openActivityModal('company', currentCompanyId));
            document.getElementById('addContactActivityBtn').addEventListener('click', () => openActivityModal('contact', currentContactId));

            // Activity type selector
            document.querySelectorAll('.activity-type-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.activity-type-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    currentActivityType = btn.dataset.type;
                    document.getElementById('activityType').value = btn.dataset.type;
                });
            });

            // Close activity modal on background click
            document.getElementById('activityModal').addEventListener('click', (e) => {
                if (e.target.id === 'activityModal') closeActivityModal();
            });
        // ============= START =============
        if (typeof gapi !== 'undefined') {
            init();
        } else {
            window.addEventListener('load', () => {
                setTimeout(init, 1000);
            });
        }
    </script>

    <!-- Tags Manager Modal -->
    <div id="tagsManagerModal" class="modal tags-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ZarzÄ…dzanie etykietami</h2>
                <button class="close-btn" onclick="closeTagsManager()">Ã—</button>
            </div>

            <!-- Tabs -->
            <div class="tags-modal-tabs">
                <button class="tags-modal-tab active" data-type="companies" onclick="switchTagsTab('companies')">
                    Etykiety firm
                </button>
                <button class="tags-modal-tab" data-type="contacts" onclick="switchTagsTab('contacts')">
                    Etykiety osÃ³b
                </button>
            </div>

            <!-- Companies Tags Section -->
            <div id="companiesTagsSection" class="tags-section active">
                <div class="tag-form-section">
                    <form id="companyTagForm" onsubmit="return saveCompanyTag(event)">
                        <div class="form-group">
                            <label>Nazwa etykiety</label>
                            <input type="text" id="companyTagName" placeholder="np. VIP Klient" required>
                            <input type="hidden" id="companyTagId">
                            <input type="hidden" id="companyTagRowIndex">
                        </div>
                        <div class="form-group">
                            <label>Kolor</label>
                            <div class="color-picker-grid" id="companyTagColorPicker"></div>
                            <input type="hidden" id="companyTagColor" value="#3b82f6">
                        </div>
                        <div class="form-group">
                            <label>Opis <span class="optional">(opcjonalnie)</span></label>
                            <textarea id="companyTagDescription" placeholder="Opis etykiety..." rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <span id="companyTagSubmitText">Dodaj etykietÄ™</span>
                        </button>
                    </form>
                </div>
                <div class="tags-list-section">
                    <h3>IstniejÄ…ce etykiety</h3>
                    <div id="companyTagsList" class="tags-list"></div>
                </div>
            </div>

            <!-- Contacts Tags Section -->
            <div id="contactsTagsSection" class="tags-section" style="display: none;">
                <div class="tag-form-section">
                    <form id="contactTagForm" onsubmit="return saveContactTag(event)">
                        <div class="form-group">
                            <label>Nazwa etykiety</label>
                            <input type="text" id="contactTagName" placeholder="np. Decydent" required>
                            <input type="hidden" id="contactTagId">
                            <input type="hidden" id="contactTagRowIndex">
                        </div>
                        <div class="form-group">
                            <label>Kolor</label>
                            <div class="color-picker-grid" id="contactTagColorPicker"></div>
                            <input type="hidden" id="contactTagColor" value="#3b82f6">
                        </div>
                        <div class="form-group">
                            <label>Opis <span class="optional">(opcjonalnie)</span></label>
                            <textarea id="contactTagDescription" placeholder="Opis etykiety..." rows="2"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary" style="width: 100%;">
                            <span id="contactTagSubmitText">Dodaj etykietÄ™</span>
                        </button>
                    </form>
                </div>
                <div class="tags-list-section">
                    <h3>IstniejÄ…ce etykiety</h3>
                    <div id="contactTagsList" class="tags-list"></div>
                </div>
            </div>
        </div>
    </div>
<!-- MODAL: ADD ACTIVITY -->
    <div id="activityModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="activityModalTitle">Dodaj aktywnoÅ›Ä‡</h2>
                <button class="close-btn" id="closeActivityModalBtn">&times;</button>
            </div>
            <form id="activityForm">
                <input type="hidden" id="activityEntityType">
                <input type="hidden" id="activityEntityId">
                <input type="hidden" id="activityType" value="EMAIL">
                
                <!-- Type selector -->
                <div class="form-group">
                    <label>Typ aktywnoÅ›ci *</label>
                    <div class="activity-type-selector" id="activityTypeSelector">
                        <button type="button" class="activity-type-btn active" data-type="EMAIL">
                            <span class="type-icon">ðŸ“§</span>
                            <span class="type-label">Email</span>
                        </button>
                        <button type="button" class="activity-type-btn" data-type="PHONE">
                            <span class="type-icon">ðŸ“ž</span>
                            <span class="type-label">Telefon</span>
                        </button>
                        <button type="button" class="activity-type-btn" data-type="MEETING">
                            <span class="type-icon">ðŸ¤</span>
                            <span class="type-label">Spotkanie</span>
                        </button>
                        <button type="button" class="activity-type-btn" data-type="TASK">
                            <span class="type-icon">âœ…</span>
                            <span class="type-label">Zadanie</span>
                        </button>
                    </div>
                </div>
                
                <!-- Title -->
                <div class="form-group">
                    <label for="activityTitle">TytuÅ‚ *</label>
                    <input type="text" id="activityTitle" required placeholder="np. Rozmowa ws. oferty">
                </div>
                
                <!-- Date -->
                <div class="form-group">
                    <label for="activityDate">Data i czas *</label>
                    <input type="datetime-local" id="activityDate" required>
                </div>
                
                <!-- Notes -->
                <div class="form-group">
                    <label for="activityNotes">Notatki <span class="optional">(opcjonalnie)</span></label>
                    <textarea id="activityNotes" placeholder="SzczegÃ³Å‚owe informacje..."></textarea>
                </div>
                
                <!-- Contact selector (when from company) -->
                <div class="form-group" id="activityContactSelectorGroup" style="display: none;">
                    <label for="activityContactSelect">Przypisz do osoby <span class="optional">(opcjonalnie)</span></label>
                    <select id="activityContactSelect">
                        <option value="">Tylko firma</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" id="cancelActivityBtn">Anuluj</button>
                    <button type="submit" class="btn btn-primary">Zapisz aktywnoÅ›Ä‡</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
